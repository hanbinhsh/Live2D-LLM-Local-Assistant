<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœ‹æ¿å¨˜æ§åˆ¶å° - è®¾ç½®ä¸­å¿ƒ</title>
    <script src="assets/jquery.min.js?v=3.3.1"></script>
    <!-- å¤ç”¨éƒ¨åˆ†åŸæœ‰æ ·å¼ -->
    <link rel="stylesheet" type="text/css" href="assets/waifu.css?v=1.4.2"/>
    
    <style>
        /* --- åŸºç¡€é‡ç½®ä¸å¸ƒå±€ä¼˜åŒ– --- */
        * { box-sizing: border-box; }

        body {
            background-color: #f5f7fa;
            font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #444;
        }

        .waifu-settings-wrapper {
            width: 100%;
            max-width: 850px;
            background: #fff;
            box-shadow: 0 8px 24px rgba(0,0,0,0.05);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 85vh;
            border: 1px solid #ebeef5;
        }

        /* --- å¤´éƒ¨ä¸å¯¼èˆª --- */
        .settings-header {
            padding: 18px 24px;
            background: #fff;
            border-bottom: 1px solid #ebeef5;
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
        }
        .settings-close { display: none; }

        .settings-tabs {
            padding: 0 24px;
            background: #fcfcfc;
            border-bottom: 1px solid #ebeef5;
            display: flex;
            gap: 20px;
        }
        .settings-tab-item {
            padding: 16px 0;
            font-size: 14px;
            color: #606266;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
        }
        .settings-tab-item:hover { color: #409eff; }
        .settings-tab-item.active {
            color: #409eff;
            border-bottom-color: #409eff;
        }

        /* --- å†…å®¹åŒºåŸŸ --- */
        .settings-content {
            padding: 24px 30px;
            overflow-y: auto;
            flex: 1;
        }
        
        .setting-section-title {
            font-size: 13px;
            color: #909399;
            margin: 20px 0 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-left: 3px solid #409eff;
            padding-left: 8px;
            line-height: 1;
        }
        .setting-section-title:first-child { margin-top: 0; }

        /* --- è¡¨å•æ§ä»¶é€šç”¨æ ·å¼ --- */
        .setting-group {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            padding: 4px 0;
        }

        /* æ ‡ç­¾æ ·å¼ä¼˜åŒ–ï¼šæ”¯æŒå†…éƒ¨åŒ…å«æŒ‰é’® */
        .setting-group label.setting-label {
            width: 220px;
            flex-shrink: 0;
            margin-bottom: 0;
            font-size: 14px;
            color: #606266;
            display: flex;
            align-items: center;
            /* å¦‚æœæ ‡ç­¾å†…æœ‰æŒ‰é’®ï¼Œè®©å®ƒä»¬ä¸¤ç«¯å¯¹é½æˆ–ä¿æŒé—´è· */
            gap: 8px; 
            padding-right: 15px;
        }

        /* è¾“å…¥æ¡†ä¸ä¸‹æ‹‰æ¡†ç»Ÿä¸€ */
        .waifu-select, 
        .waifu-textarea, 
        input[type="text"], 
        input[type="password"], 
        input[type="number"] {
            flex: 1;
            max-width: 450px;
            height: 36px;
            line-height: 36px; /* ç¡®ä¿å‚ç›´å±…ä¸­ */
            padding: 0 12px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s;
            background-color: #fff;
            box-shadow: none;
            outline: none;
        }

        .waifu-select:focus,
        input:focus,
        .waifu-textarea:focus {
            border-color: #409eff;
        }
        
        /* é’ˆå¯¹ textarea ç‰¹æ®Šå¤„ç† */
        .waifu-textarea {
            height: auto;
            line-height: 1.5;
            padding: 8px 12px;
            font-family: inherit;
        }

        /* --- æŒ‰é’®æ ·å¼ä¼˜åŒ– (ç”¨äº Label å†…éƒ¨çš„åˆ·æ–°æŒ‰é’®ç­‰) --- */
        .waifu-btn.secondary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 24px;
            padding: 0 8px;
            font-size: 12px;
            border-radius: 3px;
            border: 1px solid #dcdfe6;
            background: #fff;
            color: #606266;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            line-height: 1;
        }
        .waifu-btn.secondary:hover {
            color: #409eff;
            border-color: #c6e2ff;
            background-color: #ecf5ff;
        }
        /* å¼ºåˆ¶è¦†ç›–åŸæ¥çš„ float:rightï¼Œæ”¹ç”¨ Flex */
        .setting-label button {
            float: none !important;
            margin-left: auto; /* è‡ªåŠ¨æ¨åˆ°å³è¾¹ï¼Œå‰ææ˜¯çˆ¶å…ƒç´ æ˜¯ flex */
        }

        /* --- Checkbox ç»„ä¼˜åŒ– --- */
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); /* å“åº”å¼ç½‘æ ¼ */
            gap: 10px;
            background: #fcfcfc;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #ebeef5;
            margin-bottom: 20px;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            width: auto !important;
            margin: 0;
            font-size: 13px;
            cursor: pointer;
        }
        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }
        .checkbox-group hr {
            grid-column: 1 / -1; /* åˆ†å‰²çº¿å æ»¡æ•´è¡Œ */
            border-top-color: #e4e7ed;
            margin: 5px 0;
        }

        /* --- Prompt åŒºåŸŸç‰¹æ®Šå¤„ç† --- */
        .prompt-group {
            display: block;
            margin-bottom: 20px;
        }
        /* é‡å†™ Prompt çš„ Labelï¼Œä½¿å…¶æˆä¸º Flex å®¹å™¨ä»¥å¯¹é½å³ä¾§æŒ‰é’® */
        .prompt-group .setting-label {
            width: 100% !important;
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .prompt-group textarea {
            width: 100%;
            max-width: 100%;
            height: 100px;
            resize: vertical;
        }

        /* --- åº•éƒ¨æç¤º --- */
        .footer-tip {
            text-align: center;
            padding: 12px;
            background: #fdfdfd;
            color: #909399;
            font-size: 12px;
            border-top: 1px solid #ebeef5;
        }
    </style>
</head>
<body>

    <div class="waifu-settings-wrapper">
        <div class="settings-header">
            <span>ğŸ”§ çœ‹æ¿å¨˜è®¾ç½®ä¸­å¿ƒ</span>
        </div>
        
        <!-- é¡¶éƒ¨ Tab å¯¼èˆª -->
        <div class="settings-tabs">
            <div class="settings-tab-item active" data-tab="general">å¸¸è§„è®¾ç½®</div>
            <div class="settings-tab-item" data-tab="style">å¤–è§‚æ ·å¼</div>
            <div class="settings-tab-item" data-tab="toolbar">å·¥å…·æ </div>
            <div class="settings-tab-item" data-tab="llm">LLM & AI</div>
        </div>

        <div class="settings-content">
            
            <!-- Tab 1: å¸¸è§„è®¾ç½® -->
            <div id="tab-general" class="tab-pane active">
                <div class="setting-section-title">åç«¯ä¸API</div>
                <div class="setting-group">
                    <label class="setting-label">ä¸€è¨€ API æº</label>
                    <select data-key="hitokotoAPI" class="waifu-select config-item">
                        <option value="hitokoto.cn">hitokoto.cn (é»˜è®¤)</option>
                        <option value="lwl12.com">lwl12.com</option>
                        <option value="jinrishici.com">jinrishici.com (å¤è¯—è¯)</option>
                        <option value="fghrsh.net">fghrsh.net</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Tips JSON è·¯å¾„</label>
                    <input data-key="tipsMessage" class="waifu-select config-item" type="text">
                </div>

                <div class="setting-section-title">äº¤äº’ä¸æç¤ºæ¶ˆæ¯</div>
                <!-- Checkbox ç»„ -->
                <div class="checkbox-group">
                    <label><input data-key="showHitokoto" class="config-item" type="checkbox"> æ˜¾ç¤ºä¸€è¨€ (ç©ºé—²æ—¶)</label>
                    <label><input data-key="showWelcomeMessage" class="config-item" type="checkbox"> æ˜¾ç¤ºæ¬¢è¿è¯</label>
                    <label><input data-key="showCopyMessage" class="config-item" type="checkbox"> æ˜¾ç¤ºå¤åˆ¶æç¤º</label>
                    <label><input data-key="showF12Status" class="config-item" type="checkbox"> F12 æ˜¾ç¤ºåŠ è½½çŠ¶æ€</label>
                    <label><input data-key="showF12Message" class="config-item" type="checkbox"> F12 æ˜¾ç¤ºçœ‹æ¿å¨˜æ¶ˆæ¯</label>
                    <label><input data-key="showF12OpenMsg" class="config-item" type="checkbox"> F12 æ˜¾ç¤ºæ‰“å¼€æç¤º</label>
                </div>

                <div class="setting-section-title">æ¨¡å‹åˆ‡æ¢åå¥½</div>
                <div class="checkbox-group">
                    <label><input data-key="modelStorage" class="config-item" type="checkbox"> è®°å½•æ¨¡å‹ID (åˆ·æ–°æ¢å¤)</label>
                </div>
                <div class="setting-group">
                    <label class="setting-label">æ¨¡å‹åˆ‡æ¢æ¨¡å¼</label>
                    <select data-key="modelRandMode" class="waifu-select config-item">
                        <option value="switch">é¡ºåºåˆ‡æ¢</option>
                        <option value="rand">éšæœºåˆ‡æ¢</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label class="setting-label">æè´¨åˆ‡æ¢æ¨¡å¼</label>
                    <select data-key="modelTexturesRandMode" class="waifu-select config-item">
                        <option value="rand">éšæœºåˆ‡æ¢</option>
                        <option value="switch">é¡ºåºåˆ‡æ¢</option>
                    </select>
                </div>
            </div>

            <!-- Tab 2: æ ·å¼è®¾ç½® -->
            <div id="tab-style" class="tab-pane">
                <div class="setting-section-title">å°ºå¯¸ä¸ä½ç½®</div>
                <div class="setting-group">
                    <label class="setting-label">çœ‹æ¿å¨˜å¤§å° (å®½xé«˜)</label>
                    <input data-key="waifuSize" class="waifu-select config-item" type="text" placeholder="280x250">
                </div>
                <div class="setting-group">
                    <label class="setting-label">æç¤ºæ¡†å¤§å° (å®½xé«˜)</label>
                    <input data-key="waifuTipsSize" class="waifu-select config-item" type="text" placeholder="250x75">
                </div>
                <div class="setting-group">
                    <label class="setting-label">å­—ä½“å¤§å°</label>
                    <input data-key="waifuFontSize" class="waifu-select config-item" type="text" placeholder="12px">
                </div>
                <div class="setting-group">
                    <label class="setting-label">è´´è¾¹è®¾ç½® (left:0 / right:30)</label>
                    <input data-key="waifuEdgeSide" class="waifu-select config-item" type="text">
                </div>
                
                <div class="setting-section-title">äº¤äº’è¡Œä¸º</div>
                <div class="setting-group">
                    <label class="setting-label">æ‹–æ‹½è®¾ç½®</label>
                    <select data-key="waifuDraggable" class="waifu-select config-item">
                        <option value="disable">ç¦ç”¨æ‹–æ‹½</option>
                        <option value="axis-x">æ°´å¹³æ‹–æ‹½</option>
                        <option value="unlimited">è‡ªç”±æ‹–æ‹½</option>
                    </select>
                </div>
                <div class="checkbox-group">
                    <label><input data-key="waifuDraggableRevert" class="config-item" type="checkbox"> æ¾å¼€é¼ æ ‡è¿˜åŸä½ç½®</label>
                </div>

                <div class="setting-section-title">å·¥å…·æ å¾®è°ƒ</div>
                <div class="setting-group">
                    <label class="setting-label">å·¥å…·æ å­—ä½“å¤§å°</label>
                    <input data-key="waifuToolFont" class="waifu-select config-item" type="text" placeholder="14px">
                </div>
                <div class="setting-group">
                    <label class="setting-label">å·¥å…·æ è¡Œé«˜</label>
                    <input data-key="waifuToolLine" class="waifu-select config-item" type="text" placeholder="20px">
                </div>
                <div class="setting-group">
                    <label class="setting-label">å·¥å…·æ é¡¶éƒ¨åç§»</label>
                    <input data-key="waifuToolTop" class="waifu-select config-item" type="text" placeholder="-20px">
                </div>
            </div>

            <!-- Tab 3: å·¥å…·æ è®¾ç½® -->
            <div id="tab-toolbar" class="tab-pane">
                <div class="setting-section-title">æŒ‰é’®æ˜¾ç¤ºå¼€å…³</div>
                <div class="checkbox-group">
                    <label><input data-key="showToolMenu" class="config-item" type="checkbox"> <b>æ˜¾ç¤ºæ•´ä¸ªå·¥å…·æ </b></label>
                    <hr>
                    <label><input data-key="canTurnToHomePage" class="config-item" type="checkbox"> è¿”å›é¦–é¡µ (æˆ¿å­)</label>
                    <label><input data-key="canSwitchHitokoto" class="config-item" type="checkbox"> ä¸€è¨€åˆ‡æ¢ (æ°”æ³¡)</label>
                    <label><input data-key="canSwitchModel" class="config-item" type="checkbox"> æ¨¡å‹åˆ‡æ¢ (çœ¼ç›)</label>
                    <label><input data-key="canSwitchTextures" class="config-item" type="checkbox"> æè´¨åˆ‡æ¢ (è¡£æœ)</label>
                    <label><input data-key="canTakeScreenshot" class="config-item" type="checkbox"> çœ‹æ¿å¨˜æˆªå›¾ (ç›¸æœº)</label>
                    <label><input data-key="canTurnToAboutPage" class="config-item" type="checkbox"> å…³äºé¡µ (ä¿¡æ¯)</label>
                    <label><input data-key="canCloseLive2d" class="config-item" type="checkbox"> å…³é—­çœ‹æ¿å¨˜ (å‰å·)</label>
                    <hr>
                    <label style="color:#409eff; font-weight:bold;"><input data-key="showLLM" class="config-item" type="checkbox"> LLM å¯¹è¯ (æ˜Ÿæ˜Ÿ)</label>
                    <label style="color:#409eff; font-weight:bold;"><input data-key="showPeek" class="config-item" type="checkbox"> Peek å±å¹•è§‚å¯Ÿ (å½•åƒæœº)</label>
                    <label style="color:#409eff; font-weight:bold;"><input data-key="showSettings" class="config-item" type="checkbox"> è®¾ç½®é¢æ¿ (é½¿è½®)</label>
                </div>
            </div>

            <!-- Tab 4: LLM è®¾ç½® -->
            <div id="tab-llm" class="tab-pane">
                <div class="setting-section-title">æ ¸å¿ƒæ¥å£é…ç½®</div>
                <div class="setting-group">
                    <label class="setting-label">LLM API åœ°å€</label>
                    <input data-key="llmApiUrl" class="waifu-select config-item llm-item" type="text" placeholder="http://127.0.0.1:11434/v1/chat/completions">
                </div>
                <div class="setting-group">
                    <label class="setting-label">API Key</label>
                    <input data-key="llmApiKey" class="waifu-select config-item llm-item" type="password" placeholder="Ollamaå¯ç•™ç©º">
                </div>
                <div class="setting-group">
                    <label class="setting-label">Python åç«¯åœ°å€</label>
                    <input data-key="pythonServerUrl" class="waifu-select config-item llm-item" type="text" placeholder="http://127.0.0.1:11542/">
                </div>

                <div class="setting-section-title">æ¨¡å‹é€‰æ‹©</div>
                <div class="setting-group">
                    <!-- ä¼˜åŒ–ï¼šLabel åŒ…å«æŒ‰é’®ï¼Œé€šè¿‡ Flexbox å¯¹é½ -->
                    <label class="setting-label">
                        æ™®é€šæ¨¡å‹ 
                        <button id="btn-refresh-models" class="waifu-btn secondary">åˆ·æ–°åˆ—è¡¨</button>
                    </label>
                    <select id="model-normal" class="waifu-select llm-item">
                        <option value="">ç‚¹å‡»æŒ‰é’®åˆ·æ–°...</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label class="setting-label">æ€è€ƒæ¨¡å‹</label>
                    <select id="model-thinking" class="waifu-select llm-item">
                        <option value="">ç‚¹å‡»æŒ‰é’®åˆ·æ–°...</option>
                    </select>
                </div>

                <div class="setting-section-title">åŠŸèƒ½å¼€å…³</div>
                <div class="checkbox-group">
                    <label><input id="use-thinking-waifu" class="llm-item" type="checkbox"> çœ‹æ¿å¨˜å¯¹è¯ä½¿ç”¨æ€è€ƒæ¨¡å‹</label>
                    <label><input id="use-thinking-chat" class="llm-item" type="checkbox"> èŠå¤©åŠ©æ‰‹ä½¿ç”¨æ€è€ƒæ¨¡å‹</label>
                    <label><input id="use-thinking-roast" class="llm-item" type="checkbox"> å±å¹•åæ§½ä½¿ç”¨æ€è€ƒæ¨¡å‹</label>
                </div>
                
                <div class="setting-section-title">å®šæ—¶è®¾ç½®</div>
                <div class="setting-group">
                    <label class="setting-label">è‡ªåŠ¨åæ§½é—´éš” (ms)</label>
                    <input data-key="roastInterval" class="waifu-select config-item llm-item" type="number" placeholder="60000">
                </div>
                <div class="checkbox-group">
                    <label><input data-key="autoRoast" class="config-item llm-item" type="checkbox"> å¼€å¯è‡ªåŠ¨å®šæ—¶åæ§½</label>
                </div>

                <div class="setting-section-title">Peek (å±å¹•è§‚å¯Ÿ) å‚æ•°</div>
                <div class="setting-group">
                    <label class="setting-label">åŠŸèƒ½æ¨¡å¼</label>
                    <select id="peek-mode" class="waifu-select llm-item">
                        <option value="roast">å±å¹•åæ§½ (Roast)</option>
                        <option value="chat">èŠå¤©åŠ©æ‰‹ (Chat Helper)</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label class="setting-label">æˆªå›¾èŒƒå›´</label>
                    <select id="peek-target-type" class="waifu-select llm-item">
                        <option value="fullscreen">å…¨å±æˆªå›¾</option>
                        <option value="window">æŒ‡å®šçª—å£</option>
                    </select>
                </div>
                <div class="setting-group" id="group-window-select" style="display:none;">
                    <label class="setting-label">
                        ç›®æ ‡çª—å£
                        <button id="btn-refresh-windows" class="waifu-btn secondary">åˆ·æ–°</button>
                    </label>
                    <select id="peek-window-list" class="waifu-select llm-item">
                        <option value="0">è¯·ç‚¹å‡»åˆ·æ–°...</option>
                    </select>
                </div>

                <!-- æç¤ºè¯è¾“å…¥æ¡†ä¼˜åŒ–ï¼šFlex å¸ƒå±€æ ‡é¢˜æ  -->
                <div class="prompt-group" id="group-prompt-roast">
                    <label class="setting-label">
                        <span>åæ§½æç¤ºè¯</span>
                        <button id="btn-reset-roast" class="waifu-btn secondary">é‡ç½®é»˜è®¤</button>
                    </label>
                    <textarea id="prompt-roast" class="waifu-textarea llm-item"></textarea>
                </div>
                <div class="prompt-group" id="group-prompt-chat" style="display:none;">
                    <label class="setting-label">
                        <span>åŠ©æ‰‹æç¤ºè¯</span>
                        <button id="btn-reset-chat" class="waifu-btn secondary">é‡ç½®é»˜è®¤</button>
                    </label>
                    <textarea id="prompt-chat" class="waifu-textarea llm-item"></textarea>
                </div>
            </div>
        </div>

        <div class="footer-tip">
            è®¾ç½®å·²è‡ªåŠ¨ä¿å­˜ã€‚åˆ·æ–°ä¸»é¡µé¢æˆ–é‡æ–°æ‰“å¼€çœ‹æ¿å¨˜å³å¯ç”Ÿæ•ˆã€‚
        </div>
    </div>

    <!-- é€»è¾‘ä»£ç ä¿æŒå®Œå…¨åŸæ ·ï¼Œæœªåšä»»ä½•ä¿®æ”¹ -->
    <script>
        $(document).ready(function() {
            
            // --- 1. Tab åˆ‡æ¢é€»è¾‘ ---
            $('.settings-tab-item').click(function() {
                $('.settings-tab-item').removeClass('active');
                $(this).addClass('active');
                $('.tab-pane').hide();
                $('#tab-' + $(this).data('tab')).show();
            });

            // --- 2. å®šä¹‰é»˜è®¤é…ç½® (ä¸ live2d.js ä¿æŒä¸€è‡´ï¼Œé˜²æ­¢è¯»å–ç©ºå€¼æŠ¥é”™) ---
            var defaultGlobal = {
                'waifuSize': '280x250',
                'waifuTipsSize': '250x75',
                'waifuFontSize': '12px',
                'waifuToolFont': '14px',
                'waifuToolLine': '20px',
                'waifuToolTop': '-20px',
                'waifuDraggable': 'disable',
                'waifuDraggableRevert': true,
                'hitokotoAPI': 'hitokoto.cn',
                'showHitokoto': true,
                'showToolMenu': true,
                'modelRandMode': 'switch',
                'modelTexturesRandMode': 'rand',
                'showLLM': true,
                'showPeek': true,
                'showSettings': true,
                // ... å…¶ä»–é»˜è®¤å€¼å¯æŒ‰éœ€è¡¥å……
            };

            var defaultLLM = {
                'llmApiUrl': 'http://127.0.0.1:11434/v1/chat/completions',
                'pythonServerUrl': 'http://127.0.0.1:11542/',
                'roastInterval': 60000,
                'peekMode': 'roast',
                'targetType': 'fullscreen',
                roastPrompt: `ä½ æ˜¯ä¸€ä¸ªä½åœ¨ç”¨æˆ·ç”µè„‘æ¡Œé¢ä¸Šçš„å¯çˆ±çœ‹æ¿å¨˜ã€‚è¿™æ˜¯ç”¨æˆ·å½“å‰çš„å±å¹•æˆªå›¾ã€‚\n
ç”¨æˆ·å½“å‰æ­£åœ¨æ“ä½œçš„çª—å£æ˜¯ï¼š'/window_title'ã€‚\n
èƒŒæ™¯é‡ŒæŒ‚ç€çš„çª—å£è¿˜æœ‰ï¼š/window_listã€‚\n\n
è¯·æ ¹æ®å±å¹•å†…å®¹å’Œçª—å£åˆ¤æ–­ç”¨æˆ·æ­£åœ¨åšä»€ä¹ˆï¼Œå¹¶ä»¥**å¥³æœ‹å‹æˆ–è´´å¿ƒåŠ©æ‰‹**çš„å£å»ç›´æ¥å¯¹ç”¨æˆ·è¯´è¯ï¼ˆä½¿ç”¨ç¬¬äºŒäººç§°â€˜ä½ â€™ï¼‰ã€‚\n
è¦æ±‚ï¼š\n
1. ä¸è¦æè¿°ç”»é¢å†…å®¹ï¼Œç›´æ¥å¼€å¯è¯é¢˜ã€‚\n
2. è¿™æ˜¯ä¸€ä¸ªçŒœæµ‹äº’åŠ¨çš„è¿‡ç¨‹ã€‚\n
3. è¯­æ°”è¦è½¯èŒã€å¯çˆ±ã€å……æ»¡å…ƒæ°”ã€‚\n
4. å­—æ•°æ§åˆ¶åœ¨50å­—ä»¥å†…ã€‚`,
                chatPrompt: `ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½èŠå¤©åŠ©æ‰‹ã€‚å½“å‰çª—å£æ˜¯ '/window_title'ã€‚\n
è¯·é˜…è¯»å›¾ç‰‡ä¸­çš„èŠå¤©è®°å½•æˆ–æ–‡æœ¬å†…å®¹ï¼Œç»“åˆä¸Šä¸‹æ–‡ï¼Œç”Ÿæˆä¸€ä¸ªåˆé€‚çš„ã€é«˜æƒ…å•†çš„å›å¤ã€‚\n
è¯·ç›´æ¥ç»™å‡ºä½ æ­¤åˆ»ä¼šå‘é€çš„é‚£ä¸€å¥è¯ï¼Œä½ çš„å›å¤åº”åƒçœŸäººåœ¨å³æ—¶èŠå¤©ä¸­è‡ªç„¶æ‰“å‡ºçš„å†…å®¹ï¼Œä¸è¦åŒ…å«è§£é‡Šã€‚`
            };

            // --- 3. è¯»å–å¹¶å¡«å……è®¾ç½® ---
            function loadSettings() {
                // è¯»å– Global
                var savedGlobal = localStorage.getItem('waifu_global_settings');
                var configGlobal = $.extend({}, defaultGlobal, savedGlobal ? JSON.parse(savedGlobal) : {});

                // è¯»å– LLM
                var savedLLM = localStorage.getItem('waifu_llm_settings');
                var configLLM = $.extend({}, defaultLLM, savedLLM ? JSON.parse(savedLLM) : {});

                // å¡«å…… .config-item (ä¸»è¦å¯¹åº” Global)
                $('.config-item').each(function() {
                    var key = $(this).data('key');
                    // ä¼˜å…ˆä» LLM ä¸­æ‰¾ (ä¾‹å¦‚ API URL)ï¼Œå¦‚æœæ²¡æœ‰å†ä» Global æ‰¾
                    var val = configLLM[key] !== undefined ? configLLM[key] : configGlobal[key];
                    
                    if (val !== undefined) {
                        if ($(this).attr('type') === 'checkbox') {
                            $(this).prop('checked', val);
                        } else {
                            $(this).val(val);
                        }
                    }
                });

                // å¡«å…… LLM ä¸“ç”¨æ§ä»¶ (ID ç»‘å®šçš„é‚£äº›)
                $('#model-normal').val(configLLM.modelNormal);
                $('#model-thinking').val(configLLM.modelThinking);
                $('#use-thinking-waifu').prop('checked', configLLM.useThinkingWaifu);
                $('#use-thinking-chat').prop('checked', configLLM.useThinkingChat);
                $('#use-thinking-roast').prop('checked', configLLM.useThinkingRoast);
                $('#peek-mode').val(configLLM.peekMode || 'roast');
                $('#peek-target-type').val(configLLM.targetType || 'fullscreen');
                $('#prompt-roast').val(configLLM.roastPrompt);
                $('#prompt-chat').val(configLLM.chatPrompt);

                toggleLLMUI(); // åˆ·æ–° UI æ˜¾ç¤ºçŠ¶æ€
            }

            // --- 4. ä¿å­˜é€»è¾‘ ---
            function saveSettings() {
                // ä¿å­˜ Global
                var currentGlobal = localStorage.getItem('waifu_global_settings') ? JSON.parse(localStorage.getItem('waifu_global_settings')) : {};
                
                $('.config-item').each(function() {
                    var key = $(this).data('key');
                    // æ’é™¤æ‰å±äº LLM çš„ key (è™½ç„¶è¿™é‡Œæ··ç”¨äº† config-item class)
                    // ç®€å•åˆ¤æ–­ï¼šå¦‚æœå®ƒæ²¡æœ‰ llm-item è¿™ä¸ªç±»ï¼Œå°±å­˜å…¥ Global
                    if (!$(this).hasClass('llm-item')) {
                        if ($(this).attr('type') === 'checkbox') currentGlobal[key] = $(this).is(':checked');
                        else currentGlobal[key] = $(this).val();
                    }
                });
                localStorage.setItem('waifu_global_settings', JSON.stringify(currentGlobal));

                // ä¿å­˜ LLM
                var currentLLM = localStorage.getItem('waifu_llm_settings') ? JSON.parse(localStorage.getItem('waifu_llm_settings')) : {};
                
                // æ”¶é›† llm-item ç±»çš„ config-item
                $('.llm-item.config-item').each(function() {
                    var key = $(this).data('key');
                    if ($(this).attr('type') === 'checkbox') currentLLM[key] = $(this).is(':checked');
                    else currentLLM[key] = $(this).val();
                });

                // æ”¶é›† ID ç»‘å®šçš„ LLM è®¾ç½®
                currentLLM.modelNormal = $('#model-normal').val();
                currentLLM.modelThinking = $('#model-thinking').val();
                currentLLM.useThinkingWaifu = $('#use-thinking-waifu').is(':checked');
                currentLLM.useThinkingChat = $('#use-thinking-chat').is(':checked');
                currentLLM.useThinkingRoast = $('#use-thinking-roast').is(':checked');
                currentLLM.peekMode = $('#peek-mode').val();
                currentLLM.targetType = $('#peek-target-type').val();
                currentLLM.targetHwid = $('#peek-window-list').val();
                currentLLM.roastPrompt = $('#prompt-roast').val();
                currentLLM.chatPrompt = $('#prompt-chat').val();
                
                localStorage.setItem('waifu_llm_settings', JSON.stringify(currentLLM));
            }

            // ç›‘å¬æ‰€æœ‰è¾“å…¥å˜åŒ–ï¼Œè‡ªåŠ¨ä¿å­˜
            $('input, select, textarea').change(function() {
                toggleLLMUI();
                saveSettings();
            });

            // --- 5. UI è¾…åŠ©é€»è¾‘ ---
            function toggleLLMUI() {
                var mode = $('#peek-mode').val();
                var target = $('#peek-target-type').val();
                
                $('.prompt-group').hide();
                $('#group-prompt-' + mode).show();

                if (target === 'window') $('#group-window-select').show();
                else $('#group-window-select').hide();
            }

            // --- 6. è¿œç¨‹æ•°æ®è·å– (æ¨¡å‹åˆ—è¡¨ä¸çª—å£åˆ—è¡¨) ---
            // è¿™é‡Œçš„ fetchUrl éœ€è¦ä» input ä¸­åŠ¨æ€è·å–ï¼Œé˜²æ­¢ç”¨æˆ·æ”¹äº† input è¿˜æ²¡ä¿å­˜
            function getPythonUrl() {
                var url = $('input[data-key="pythonServerUrl"]').val();
                if (!url) return ''; // é˜²æ­¢ç©ºåœ°å€æŠ¥é”™
                return url.endsWith('/') ? url : url + '/';
            }

            async function fetchModelList() {
                var $btn = $('#btn-refresh-models');
                var $selects = $('#model-normal, #model-thinking');
                
                // 1. ç•Œé¢æ˜¾ç¤ºâ€œåŠ è½½ä¸­â€
                $btn.text('åˆ·æ–°ä¸­...');
                // è¿™é‡Œçš„ html() åªæ˜¯ä¸´æ—¶å ä½ï¼Œé˜²æ­¢ç”¨æˆ·çœ‹èµ·æ¥ä»¥ä¸ºåäº†
                // $selects.html('<option>åŠ è½½ä¸­...</option>'); 

                try {
                    var apiUrl = getPythonUrl();
                    if (!apiUrl) throw new Error("APIåœ°å€ä¸ºç©º");

                    // 2. è¯·æ±‚åç«¯
                    const response = await fetch(apiUrl + 'list_models');
                    const data = await response.json();
                    
                    // 3. ç”Ÿæˆ HTML é€‰é¡¹
                    var html = '';
                    if (data.models && data.models.length > 0) {
                        data.models.forEach(m => html += `<option value="${m}">${m}</option>`);
                    } else {
                        html = '<option value="">æœªæ‰¾åˆ°æ¨¡å‹</option>';
                    }
                    
                    // 4. å¡«å……ä¸‹æ‹‰æ¡†
                    $selects.html(html);

                    // 5. ã€å…³é”®ã€‘åˆ—è¡¨æœ‰äº†ä¹‹åï¼Œé‡æ–°ä» LocalStorage æ¢å¤é€‰ä¸­çš„å€¼
                    var savedLLM = JSON.parse(localStorage.getItem('waifu_llm_settings') || '{}');
                    if (savedLLM.modelNormal) $('#model-normal').val(savedLLM.modelNormal);
                    if (savedLLM.modelThinking) $('#model-thinking').val(savedLLM.modelThinking);
                    
                } catch (e) {
                    console.error(e);
                    // å¦‚æœè‡ªåŠ¨åŠ è½½å¤±è´¥ï¼ˆæ¯”å¦‚åç«¯æ²¡å¼€ï¼‰ï¼Œç»™ä¸ªå‹å¥½çš„æç¤ºï¼Œä¿ç•™åŸæ¥çš„é€‰é¡¹
                    $selects.html('<option value="">è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯</option>');
                } finally {
                    $btn.text('åˆ·æ–°åˆ—è¡¨');
                }
            }

            $('#btn-refresh-models').click(function() {
                fetchModelList();
            });

            $('#btn-refresh-windows').click(async function() {
                var $btn = $(this);
                $btn.text('...');
                try {
                    const response = await fetch(getPythonUrl() + 'list_windows');
                    const data = await response.json();
                    var html = '';
                    if (data.windows) {
                        data.windows.forEach(w => html += `<option value="${w.id}">${w.title}</option>`);
                    }
                    $('#peek-window-list').html(html);
                    
                    // æ¢å¤é€‰ä¸­çš„çª—å£ï¼ˆå¦‚æœæœ‰ï¼‰
                    var savedLLM = JSON.parse(localStorage.getItem('waifu_llm_settings') || '{}');
                    if(savedLLM.targetHwid) $('#peek-window-list').val(savedLLM.targetHwid);
                    
                } catch (e) {
                    alert('è·å–çª—å£å¤±è´¥'); // è‡ªåŠ¨åŠ è½½æ—¶æœ€å¥½åˆ«å¼¹çª—
                }
                $btn.text('åˆ·æ–°');
            });
            
            // é‡ç½®æç¤ºè¯æŒ‰é’®
            $('#btn-reset-roast').click(function(){ 
                $('#prompt-roast').val(defaultLLM.roastPrompt); saveSettings(); 
            });
            $('#btn-reset-chat').click(function(){ 
                $('#prompt-chat').val(defaultLLM.chatPrompt); saveSettings(); 
            });

            // --- 7. åˆå§‹åŒ–æ‰§è¡Œ ---
            
            // å…ˆåŠ è½½åŸºç¡€æ–‡æœ¬æ¡†è®¾ç½® (URL, API Key ç­‰)
            loadSettings(); 
            
            // ã€å…³é”®ã€‘é¡µé¢åŠ è½½æ—¶ï¼Œè‡ªåŠ¨è§¦å‘ä¸€æ¬¡æ¨¡å‹åˆ—è¡¨è·å–
            // å»¶æ—¶ä¸€ç‚¹ç‚¹ç¡®ä¿ URL å·²ç»å¡«å…¥
            setTimeout(function() {
                if ($('input[data-key="pythonServerUrl"]').val()) {
                    fetchModelList();
                    $('#btn-refresh-windows').click(); 
                }
            }, 100);
        });
    </script>
</body>
</html>