<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœ‹æ¿å¨˜æ§åˆ¶å° - è®¾ç½®ä¸­å¿ƒ</title>
    <script src="assets/waifu-config.js"></script>
    <script src="assets/jquery.min.js?v=3.3.1"></script>
    <!-- å¤ç”¨éƒ¨åˆ†åŸæœ‰æ ·å¼ -->
    <link rel="stylesheet" type="text/css" href="assets/waifu.css?v=1.4.2"/>
    
    <style>
        /* --- åŸºç¡€é‡ç½®ä¸å¸ƒå±€ä¼˜åŒ– --- */
        * { box-sizing: border-box; }

        body {
            background-color: #f5f7fa;
            font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #444;
        }

        .waifu-settings-wrapper {
            width: 100%;
            max-width: 850px;
            background: #fff;
            box-shadow: 0 8px 24px rgba(0,0,0,0.05);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 85vh;
            border: 1px solid #ebeef5;
        }

        /* --- å¤´éƒ¨ä¸å¯¼èˆª --- */
        .settings-header {
            padding: 18px 24px;
            background: #fff;
            border-bottom: 1px solid #ebeef5;
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
        }
        .settings-close { display: none; }

        .settings-tabs {
            padding: 0 24px;
            background: #fcfcfc;
            border-bottom: 1px solid #ebeef5;
            display: flex;
            gap: 20px;
        }
        .settings-tab-item {
            padding: 16px 0;
            font-size: 14px;
            color: #606266;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
        }
        .settings-tab-item:hover { color: #409eff; }
        .settings-tab-item.active {
            color: #409eff;
            border-bottom-color: #409eff;
        }

        /* --- å†…å®¹åŒºåŸŸ --- */
        .settings-content {
            padding: 24px 30px;
            overflow-y: auto;
            flex: 1;
        }
        
        .setting-section-title {
            font-size: 13px;
            color: #909399;
            margin: 20px 0 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-left: 3px solid #409eff;
            padding-left: 8px;
            line-height: 1;
        }
        .setting-section-title:first-child { margin-top: 0; }

        /* --- è¡¨å•æ§ä»¶é€šç”¨æ ·å¼ --- */
        .setting-group {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            padding: 4px 0;
        }

        /* æ ‡ç­¾æ ·å¼ä¼˜åŒ–ï¼šæ”¯æŒå†…éƒ¨åŒ…å«æŒ‰é’® */
        .setting-group label.setting-label {
            width: 220px;
            flex-shrink: 0;
            margin-bottom: 0;
            font-size: 14px;
            color: #606266;
            display: flex;
            align-items: center;
            /* å¦‚æœæ ‡ç­¾å†…æœ‰æŒ‰é’®ï¼Œè®©å®ƒä»¬ä¸¤ç«¯å¯¹é½æˆ–ä¿æŒé—´è· */
            gap: 8px; 
            /* padding-right: 15px; */
        }

        /* è¾“å…¥æ¡†ä¸ä¸‹æ‹‰æ¡†ç»Ÿä¸€ */
        .waifu-select, 
        .waifu-textarea, 
        input[type="text"], 
        input[type="password"], 
        input[type="number"] {
            flex: 1;
            max-width: 450px;
            height: 36px;
            line-height: 36px; /* ç¡®ä¿å‚ç›´å±…ä¸­ */
            padding: 0 12px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s;
            background-color: #fff;
            box-shadow: none;
            outline: none;
        }

        .waifu-select:focus,
        input:focus,
        .waifu-textarea:focus {
            border-color: #409eff;
        }
        
        /* é’ˆå¯¹ textarea ç‰¹æ®Šå¤„ç† */
        .waifu-textarea {
            height: auto;
            line-height: 1.5;
            padding: 8px 12px;
            font-family: inherit;
        }

        /* --- æŒ‰é’®æ ·å¼ä¼˜åŒ– (ç”¨äº Label å†…éƒ¨çš„åˆ·æ–°æŒ‰é’®ç­‰) --- */
        .waifu-btn.secondary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 24px;
            padding: 0 8px !important;
            font-size: 12px !important;
            border-radius: 3px;
            border: 1px solid #dcdfe6;
            background: #fff;
            color: #606266 !important;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            line-height: 1;
            margin: 5px;
        }
        .waifu-btn.secondary:hover {
            color: #409eff;
            border-color: #c6e2ff;
            background-color: #ecf5ff;
        }
        /* å¼ºåˆ¶è¦†ç›–åŸæ¥çš„ float:rightï¼Œæ”¹ç”¨ Flex */
        .setting-label button {
            float: none !important;
            margin-left: auto; /* è‡ªåŠ¨æ¨åˆ°å³è¾¹ï¼Œå‰ææ˜¯çˆ¶å…ƒç´ æ˜¯ flex */
        }

        /* --- Checkbox ç»„ä¼˜åŒ– --- */
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); /* å“åº”å¼ç½‘æ ¼ */
            gap: 10px;
            background: #fcfcfc;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #ebeef5;
            margin-bottom: 20px;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            width: auto !important;
            margin: 0;
            font-size: 13px;
            cursor: pointer;
        }
        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }
        .checkbox-group hr {
            grid-column: 1 / -1; /* åˆ†å‰²çº¿å æ»¡æ•´è¡Œ */
            border-top-color: #e4e7ed;
            margin: 5px 0;
        }

        /* --- Prompt åŒºåŸŸç‰¹æ®Šå¤„ç† --- */
        .prompt-group {
            display: block;
            margin-bottom: 20px;
        }
        /* é‡å†™ Prompt çš„ Labelï¼Œä½¿å…¶æˆä¸º Flex å®¹å™¨ä»¥å¯¹é½å³ä¾§æŒ‰é’® */
        .prompt-group .setting-label {
            width: 100% !important;
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .prompt-group textarea {
            width: 100%;
            max-width: 100%;
            height: 100px;
            resize: vertical;
        }

        .mtn-group {
            display: block;
            margin-bottom: 20px;
        }
        .mtn-group .setting-label {
            width: 100% !important;
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .mtn-group textarea {
            width: 100%;
            max-width: 100%;
            height: 100px;
            resize: vertical;
        }

        /* --- åº•éƒ¨æç¤º --- */
        .footer-tip {
            text-align: center;
            padding: 12px;
            background: #fdfdfd;
            color: #909399;
            font-size: 12px;
            border-top: 1px solid #ebeef5;
        }
    </style>
</head>
<body>

    <div class="waifu-settings-wrapper">
        <div class="settings-header">
            <span>ğŸ”§ çœ‹æ¿å¨˜è®¾ç½®ä¸­å¿ƒ</span>
        </div>
        <div id="settings-inject-container" style="height: 95%; display:flex; flex-direction:column">
            <!-- åŠ è½½ä¸­æç¤º -->
            <div style="padding:20px; text-align:center;">æ­£åœ¨åŠ è½½è®¾ç½®é¢æ¿...</div>
        </div>
    </div>

    <!-- é€»è¾‘ä»£ç å·²æ›´æ–°ä¸ºç»Ÿä¸€é…ç½®æ¨¡å¼ -->
    <script>
        $(document).ready(function() {

            $("#settings-inject-container").load("settings-content.html", function(response, status, xhr) {
                if (status == "error") {
                    $("#settings-inject-container").html("åŠ è½½è®¾ç½®æ–‡ä»¶å¤±è´¥: " + xhr.status + " " + xhr.statusText);
                    return;
                }
                
                initSettingsLogic();
            });
        });

        function initSettingsLogic() {
            // --- 2. å®šä¹‰é»˜è®¤é…ç½® (åŒ…å« Global å’Œ LLM çš„æ‰€æœ‰é»˜è®¤å€¼) ---
            // ç¡®ä¿è¿™äº› Key ä¸ JS æ–‡ä»¶ä¸­çš„ default_settings ä¸€è‡´
            var defaultSettings = JSON.parse(JSON.stringify(window.WAIFU_GLOBAL_DEFAULTS));

            // --- 3. è¯»å–å¹¶å¡«å……è®¾ç½® (ç»Ÿä¸€é€»è¾‘) ---
            function loadSettings() {
                // åªè¯»å– waifu_global_settings
                var saved = localStorage.getItem('waifu_global_settings');
                var config = $.extend({}, defaultSettings, saved ? JSON.parse(saved) : {});

                // éå†æ‰€æœ‰å¸¦æœ‰ config-item ç±»çš„è¾“å…¥æ¡†
                $('.config-item').each(function() {
                    var key = $(this).data('key');
                    var val = config[key];
                    
                    if (val !== undefined) {
                        if ($(this).attr('type') === 'checkbox') {
                            $(this).prop('checked', val);
                        } else {
                            $(this).val(val);
                        }
                    }
                });

                toggleLLMUI(); // åˆ·æ–° UI æ˜¾ç¤ºçŠ¶æ€ (UI ä¾èµ–äºå¡«å…¥çš„å€¼)
            }

            // --- 4. ä¿å­˜é€»è¾‘ (ç»Ÿä¸€é€»è¾‘) ---
            function saveSettings() {
                // è¯»å–å½“å‰å­˜å‚¨ (ä¿ç•™é‚£äº›ä¸åœ¨ç•Œé¢ä¸Šçš„è®¾ç½®ï¼Œå¦‚ modelId)
                var currentConfig = localStorage.getItem('waifu_global_settings') ? JSON.parse(localStorage.getItem('waifu_global_settings')) : {};
                
                // éå†ç•Œé¢ä¸Šçš„æ‰€æœ‰é…ç½®é¡¹ï¼Œæ›´æ–°åˆ°å¯¹è±¡ä¸­
                $('.config-item').each(function() {
                    var key = $(this).data('key');
                    if (key) {
                        if ($(this).attr('type') === 'checkbox') {
                            currentConfig[key] = $(this).is(':checked');
                        } else {
                            currentConfig[key] = $(this).val();
                        }
                    }
                });

                // ä¿å­˜å› LocalStorage
                // æ³¨æ„ï¼šè¿™é‡Œä¿å­˜åï¼Œä¸»çª—å£çš„ 'storage' äº‹ä»¶ç›‘å¬å™¨ä¼šæ•æ‰åˆ°å¹¶åŒæ­¥
                localStorage.setItem('waifu_global_settings', JSON.stringify(currentConfig));
            }

            // ç›‘å¬æ‰€æœ‰è¾“å…¥å˜åŒ–ï¼Œè‡ªåŠ¨ä¿å­˜
            $('input, select, textarea').change(function() {
                toggleLLMUI();
                saveSettings();
            });

            // --- 5. UI è¾…åŠ©é€»è¾‘ ---
            function toggleLLMUI() {
                var mode = $('#peek-mode').val();
                var target = $('#peek-target-type').val();
                
                $('.prompt-group').hide();
                $('#group-prompt-' + mode).show();

                if (target === 'window') $('#group-window-select').show();
                else $('#group-window-select').hide();
            }

            // --- 6. è¿œç¨‹æ•°æ®è·å– (æ¨¡å‹åˆ—è¡¨ä¸çª—å£åˆ—è¡¨) ---
            function getPythonUrl() {
                var url = $('input[data-key="pythonServerUrl"]').val();
                if (!url) return '';
                return url.endsWith('/') ? url : url + '/';
            }

            async function fetchModelList() {
                var $btn = $('#btn-refresh-models');
                var $selects = $('#model-normal, #model-thinking');
                
                $btn.text('åˆ·æ–°ä¸­...');

                try {
                    var apiUrl = getPythonUrl();
                    if (!apiUrl) throw new Error("APIåœ°å€ä¸ºç©º");

                    const response = await fetch(apiUrl + 'list_models');
                    const data = await response.json();
                    
                    var html = '';
                    if (data.models && data.models.length > 0) {
                        data.models.forEach(m => html += `<option value="${m}">${m}</option>`);
                    } else {
                        html = '<option value="">æœªæ‰¾åˆ°æ¨¡å‹</option>';
                    }
                    
                    $selects.html(html);

                    // åˆ—è¡¨åˆ·æ–°åï¼Œé‡æ–°ä» LocalStorage æ¢å¤é€‰ä¸­çš„å€¼
                    // å¦åˆ™ä¸‹æ‹‰æ¡†ä¼šé‡ç½®ä¸ºç¬¬ä¸€ä¸ªé€‰é¡¹
                    var saved = JSON.parse(localStorage.getItem('waifu_global_settings') || '{}');
                    if (saved.modelNormal){
                        if($('#model-normal option[value="' + saved.modelNormal + '"]').length === 0)
                            $('#model-normal').html(`<option value="${saved.modelNormal}">${saved.modelNormal}</option>`);
                        $('#model-normal').val(saved.modelNormal);
                    }
                        
                    if (saved.modelThinking){
                        if ($('#model-thinking option[value="' + saved.modelThinking + '"]').length === 0)
                            $('#model-thinking').html(`<option value="${saved.modelThinking}">${saved.modelThinking}</option>`);
                        $('#model-thinking').val(saved.modelThinking);
                    }
                } catch (e) {
                    console.error("æ¨¡å‹åˆ—è¡¨è·å–å¤±è´¥ï¼š", e);
                    if (saved.modelNormal){
                        $('#model-normal').html(`<option value="${saved.modelNormal}">${saved.modelNormal} (ç¦»çº¿)</option>`);
                        $('#model-normal').val(saved.modelNormal);
                    }
                    if (saved.modelThinking){
                        $('#model-thinking').html(`<option value="${saved.modelThinking}">${saved.modelThinking} (ç¦»çº¿)</option>`);
                        $('#model-thinking').val(saved.modelThinking);
                    }
                } finally {
                    $btn.text('åˆ·æ–°åˆ—è¡¨');
                }
            }

            $('#btn-refresh-models').click(function() {
                fetchModelList();
            });

            $('#btn-clear-memory').click(function() {
                if(confirm('ç¡®å®šè¦è®©çœ‹æ¿å¨˜å¿˜è®°ä¹‹å‰çš„æ‰€æœ‰å¯¹è¯å—ï¼Ÿ')) {
                    localStorage.removeItem('waifu_chat_history');
                }
            });

            $('#btn-refresh-windows').click(async function() {
                var $btn = $(this);
                $btn.text('...');
                try {
                    const response = await fetch(getPythonUrl() + 'list_windows');
                    const data = await response.json();
                    var html = '';
                    if (data.windows) {
                        data.windows.forEach(w => html += `<option value="${w.id}">${w.title}</option>`);
                    }
                    $('#peek-window-list').html(html);
                    
                    var saved = JSON.parse(localStorage.getItem('waifu_global_settings') || '{}');
                    if(saved.targetHwid) $('#peek-window-list').val(saved.targetHwid);
                    
                } catch (e) {
                    alert('è·å–çª—å£å¤±è´¥');
                }
                $btn.text('åˆ·æ–°');
            });
            
            // é‡ç½®æç¤ºè¯æŒ‰é’®
            $('#btn-reset-roast').click(function(){ 
                $('#prompt-roast').val(defaultSettings.roastPrompt); saveSettings(); 
            });
            $('#btn-reset-chat').click(function(){ 
                $('#prompt-chat').val(defaultSettings.chatPrompt); saveSettings(); 
            });
            $('#btn-reset-waifu').click(function(){ 
                $('#prompt-waifu').val(defaultSettings.waifuPrompt); saveSettings(); 
            });

            // --- 7. åˆå§‹åŒ–æ‰§è¡Œ ---
            
            // åŠ è½½æ‰€æœ‰è®¾ç½®
            loadSettings(); 
            
            // è‡ªåŠ¨å°è¯•åŠ è½½æ¨¡å‹åˆ—è¡¨
            setTimeout(function() {
                if ($('input[data-key="pythonServerUrl"]').val()) {
                    fetchModelList();
                    $('#btn-refresh-windows').click(); 
                }
            }, 100);
        }
    </script>
</body>
</html>