<!-- 顶部 Tab 导航 -->
<div class="settings-tabs">
    <div class="settings-tab-item active" data-tab="general">常规</div>
    <div class="settings-tab-item" data-tab="style">样式</div>
    <div class="settings-tab-item" data-tab="toolbar">工具栏</div>
    <div class="settings-tab-item" data-tab="llm">LLM</div>
    <div class="settings-tab-item" data-tab="debug">调试</div>
</div>
<div class="settings-content">
    <!-- Tab 1: 常规设置 (接口、提示消息、杂项) -->
    <div id="tab-general" class="tab-pane active">
        <div class="setting-section-title">后端与API</div>
        <div class="setting-group">
            <label class="setting-label">一言 API 源</label>
            <select data-key="hitokotoAPI" class="waifu-select config-item">
                <option value="hitokoto.cn">hitokoto.cn (默认)</option>
                <option value="lwl12.com">lwl12.com</option>
                <option value="jinrishici.com">jinrishici.com (古诗词)</option>
                <option value="fghrsh.net">fghrsh.net</option>
            </select>
        </div>
        <div class="setting-group">
            <label class="setting-label">Tips JSON 路径</label>
            <input data-key="tipsMessage" class="waifu-select config-item" type="text">
        </div>
        <div class="setting-section-title">交互与提示消息</div>
        <div class="setting-group checkbox-group">
            <label><input data-key="showHitokoto" class="config-item" type="checkbox"> 显示一言 (空闲时)</label>
            <label><input data-key="showWelcomeMessage" class="config-item" type="checkbox"> 显示欢迎词</label>
            <label><input data-key="showCopyMessage" class="config-item" type="checkbox"> 显示复制提示</label>
            <label><input data-key="showF12Status" class="config-item" type="checkbox"> F12 显示加载状态</label>
            <label><input data-key="showF12Message" class="config-item" type="checkbox"> F12 显示看板娘消息</label>
            <label><input data-key="showF12OpenMsg" class="config-item" type="checkbox"> F12 显示打开提示</label>
        </div>
        <div class="setting-section-title">模型切换偏好</div>
        <div class="setting-group checkbox-group">
            <label><input data-key="modelStorage" class="config-item" type="checkbox"> 记录模型ID (刷新恢复)</label>
        </div>
        <div class="setting-group">
            <label class="setting-label">模型切换模式</label>
            <select data-key="modelRandMode" class="waifu-select config-item">
                <option value="switch">顺序切换</option>
                <option value="rand">随机切换</option>
            </select>
        </div>
        <div class="setting-group">
            <label class="setting-label">材质切换模式</label>
            <select data-key="modelTexturesRandMode" class="waifu-select config-item">
                <option value="rand">随机切换</option>
                <option value="switch">顺序切换</option>
            </select>
        </div>
    </div>
    <!-- Tab 2: 样式设置 -->
    <div id="tab-style" class="tab-pane" style="display:none;">
        <div class="setting-section-title">尺寸与位置 (需刷新生效)</div>
        <div class="setting-group">
            <label class="setting-label">看板娘大小 (宽x高)</label>
            <input data-key="waifuSize" class="waifu-select config-item" type="text" placeholder="280x250">
        </div>
        <div class="setting-group">
            <label class="setting-label">提示框大小 (宽x高)</label>
            <input data-key="waifuTipsSize" class="waifu-select config-item" type="text" placeholder="250x75">
        </div>
        <div class="setting-group">
            <label class="setting-label">字体大小</label>
            <input data-key="waifuFontSize" class="waifu-select config-item" type="text" placeholder="12px">
        </div>
        <div class="setting-group">
            <label class="setting-label">贴边设置 (left:0 / right:30)</label>
            <input data-key="waifuEdgeSide" class="waifu-select config-item" type="text">
        </div>
        <div class="setting-section-title">工具栏样式</div>
        <div class="setting-group">
            <label class="setting-label">工具栏字体大小</label>
            <input data-key="waifuToolFont" class="waifu-select config-item" type="text" placeholder="14px">
        </div>
        <div class="setting-group">
            <label class="setting-label">工具栏行高</label>
            <input data-key="waifuToolLine" class="waifu-select config-item" type="text" placeholder="20px">
        </div>
        <div class="setting-group">
            <label class="setting-label">工具栏顶部偏移</label>
            <input data-key="waifuToolTop" class="waifu-select config-item" type="text" placeholder="-20px">
        </div>
        
        <div class="setting-section-title">交互行为</div>
        <div class="setting-group">
            <label class="setting-label">拖拽设置</label>
            <select data-key="waifuDraggable" class="waifu-select config-item">
                <option value="disable">禁用拖拽</option>
                <option value="axis-x">水平拖拽</option>
                <option value="unlimited">自由拖拽</option>
            </select>
        </div>
        <div class="setting-group checkbox-group">
            <label><input data-key="waifuDraggableRevert" class="config-item" type="checkbox"> 松开鼠标还原位置</label>
        </div>
    </div>
    <!-- Tab 3: 工具栏设置 -->
    <div id="tab-toolbar" class="tab-pane" style="display:none;">
        <div class="setting-section-title">按钮显示开关</div>
        <div class="setting-group checkbox-group">
            <label><input data-key="showToolMenu" class="config-item" type="checkbox"> <b>显示整个工具栏</b></label>
            <hr>
            <label><input data-key="canTurnToHomePage" class="config-item" type="checkbox"> 返回首页 (房子)</label>
            <label><input data-key="canSwitchHitokoto" class="config-item" type="checkbox"> 一言切换 (气泡)</label>
            <label><input data-key="canSwitchModel" class="config-item" type="checkbox"> 模型切换 (眼睛)</label>
            <label><input data-key="canSwitchTextures" class="config-item" type="checkbox"> 材质切换 (衣服)</label>
            <label><input data-key="canTakeScreenshot" class="config-item" type="checkbox"> 看板娘截图 (相机)</label>
            <label><input data-key="canTurnToAboutPage" class="config-item" type="checkbox"> 关于页 (信息)</label>
            <label><input data-key="canCloseLive2d" class="config-item" type="checkbox"> 关闭看板娘 (叉号)</label>
            <label><input data-key="showLLM" class="config-item" type="checkbox"> LLM 对话 (星星)</label>
            <label><input data-key="showHistory" class="config-item" type="checkbox"> 对话历史 (信封)</label>
            <label><input data-key="showPeek" class="config-item" type="checkbox"> Peek 屏幕观察 (录像机)</label>
            <label><input data-key="showSettings" class="config-item" type="checkbox"> 设置面板 (齿轮)</label>
        </div>
    </div>
    <!-- Tab 4: LLM 设置 -->
    <div id="tab-llm" class="tab-pane" style="display:none;">
        <div class="setting-section-title">核心接口配置</div>
        <div class="setting-group">
            <label class="setting-label">LLM API 地址</label>
            <input data-key="llmApiUrl" class="waifu-select config-item" type="text" placeholder="http://127.0.0.1:11434/v1/chat/completions">
        </div>
        <div class="setting-group">
            <label class="setting-label">API Key (Ollama可留空)</label>
            <input data-key="llmApiKey" class="waifu-select config-item" type="password">
        </div>
        <div class="setting-group">
            <label class="setting-label">Python 后端地址 (Peek)</label>
            <input data-key="pythonServerUrl" class="waifu-select config-item" type="text" placeholder="http://127.0.0.1:11542/">
        </div>
        <div class="setting-section-title" style="margin-top:15px;">模型选择</div>
        <div class="setting-group">
            <label class="setting-label">
                普通模型 (响应快)
                <button id="btn-refresh-models" class="waifu-btn secondary" style="padding:1px 5px;font-size:10px;float:right;">刷新列表</button>
            </label>
            <select id="model-normal" data-key="modelNormal" class="waifu-select config-item">
                <option value="">点击刷新...</option>
            </select>
        </div>
        <div class="setting-group">
            <label class="setting-label">思考模型 (能力强)</label>
            <select id="model-thinking" data-key="modelThinking" class="waifu-select config-item">
                <option value="">点击刷新...</option>
            </select>
        </div>
        <div class="setting-section-title" style="margin-top:15px;">功能开关</div>
        <div class="setting-group checkbox-group">
            <label><input id="use-thinking-waifu" data-key="useThinkingWaifu" class="config-item" type="checkbox"> 看板娘对话使用思考模型</label>
            <label><input id="use-thinking-chat" data-key="useThinkingChat" class="config-item" type="checkbox"> 聊天助手使用思考模型</label>
            <label><input id="use-thinking-roast" data-key="useThinkingRoast" class="config-item" type="checkbox"> 屏幕吐槽使用思考模型</label>
        </div>
        <div class="setting-section-title">对话记忆</div>
        <div class="setting-group checkbox-group">
            <label><input id="use-memory" data-key="useMemory" class="llm-item config-item" type="checkbox"> 多轮对话记忆</label>
            <span style="font-size:12px;color:#999;">看板娘会记得你说过的话 (刷新网页依然有效)</span>
        </div>
        <div class="setting-group">
            <label class="setting-label">记忆轮数限制 (1轮=一问一答)</label>
            <div style="display:flex; gap:10px;">
                <input id="memory-limit" data-key="memoryLimit" class="waifu-select llm-item config-item" type="number" placeholder="10" style="width:80px; flex:none;">
                <button id="btn-clear-memory" class="waifu-btn secondary" style="float:right;padding:1px 5px;font-size:10px;">清除记忆</button>
                <button id="btn-export-history" class="waifu-btn secondary" style="float:right;padding:1px 5px;font-size:10px;">
                    导出记录
                </button>
                <button id="btn-import-history" class="waifu-btn secondary" style="float:right;padding:1px 5px;font-size:10px;">
                    导入记录
                </button>
                <input type="file" id="file-import-input" accept=".json" style="display:none;">
            </div>
        </div>
        <div class="setting-section-title" style="margin-top:15px;">自动与定时</div>
        <div class="setting-group checkbox-group">
            <label><input data-key="autoRoast" class="config-item" type="checkbox"> 开启自动定时吐槽</label>
        </div>
        <div class="setting-group">
            <label class="setting-label">自动间隔 (毫秒, 60000=1分钟)</label>
            <input data-key="roastInterval" class="waifu-select config-item" type="number">
        </div>
        <hr style="border:0; border-top:1px dashed #ddd; margin:15px 0;">
        <div class="setting-section-title">提示词</div>
        <div class="setting-group" id="group-prompt-waifu" style="margin-top:10px;">
            <label class="setting-label">
                看板娘人设 (对话模式)
                <button id="btn-reset-waifu" class="waifu-btn secondary" style="float:right;padding:1px 5px;font-size:10px;">重置</button>
            </label>
            <textarea id="prompt-waifu" data-key="waifuPrompt" class="waifu-textarea config-item"></textarea>
        </div>
        <hr style="border:0; border-top:1px dashed #ddd; margin:15px 0;">
        <div class="setting-section-title">Peek 详细参数</div>
        <div class="setting-group">
            <label class="setting-label">功能模式</label>
            <select id="peek-mode" data-key="peekMode" class="waifu-select config-item">
                <option value="roast">屏幕吐槽 (Roast)</option>
                <option value="chat">聊天助手 (Chat Helper)</option>
            </select>
        </div>
        <div class="setting-group">
            <label class="setting-label">截图范围</label>
            <select id="peek-target-type" data-key="targetType" class="waifu-select config-item">
                <option value="fullscreen">全屏截图</option>
                <option value="window">指定窗口</option>
            </select>
        </div>
        <div class="setting-group" id="group-window-select" style="display:none;">
            <label class="setting-label">
                选择窗口 
                <button id="btn-refresh-windows" class="waifu-btn secondary" style="padding:2px 5px; font-size:10px;">刷新</button>
            </label>
            <select id="peek-window-list" data-key="targetHwid" class="waifu-select config-item">
                <option value="0">请点击刷新...</option>
            </select>
        </div>
        <div class="setting-group prompt-group" id="group-prompt-roast" style="margin-top:10px;">
            <label class="setting-label">
                吐槽提示词 
                <button id="btn-reset-roast" class="waifu-btn secondary" style="float:right;padding:1px 5px;font-size:10px;">重置</button>
            </label>
            <textarea id="prompt-roast" data-key="roastPrompt" class="waifu-textarea config-item"></textarea>
        </div>
        <div class="setting-group prompt-group" id="group-prompt-chat" style="display:none;margin-top:10px;">
            <label class="setting-label">
                助手提示词
                <button id="btn-reset-chat" class="waifu-btn secondary" style="float:right;padding:1px 5px;font-size:10px;">重置</button>
            </label>
            <textarea id="prompt-chat" data-key="chatPrompt" class="waifu-textarea config-item"></textarea>
        </div>
    </div>
    <!-- Tab 5: 模型调试 -->
    <div id="tab-debug" class="tab-pane" style="display:none;">
        <div class="setting-section-title">模型调试 (Debug)</div>
        <div class="setting-group">
            <label class="setting-label">表情 (Expression)</label>
            <select id="debug-expression-select" class="waifu-select config-item">
                <option value="">加载中...</option>
            </select>
        </div>
        <div class="setting-group">
            <label class="setting-label">动作 (Motion)</label>
            <select id="debug-motion-select" class="waifu-select config-item">
                <option value="">加载中...</option>
            </select>
            <button id="btn-play-motion" class="waifu-btn secondary" style="margin-left:5px;">播放</button>
        </div>
    </div>  
    <!-- 底部保存提示 -->
    <div style="text-align:center; padding:10px; color:#888; font-size:12px; border-top:1px solid #eee; background:#fafafa;">
        部分设置刷新网页后生效
    </div>
</div>

<script>

    // --- Tab 切换 ---
    $('.settings-tab-item').click(function() {
        $('.settings-tab-item').removeClass('active');
        $(this).addClass('active');
        $('.tab-pane').hide();
        $('#tab-' + $(this).data('tab')).show();
    });

    $('#btn-export-history').click(function() {
        // 1. 获取数据
        var historyStr = localStorage.getItem('waifu_chat_history');
        if (!historyStr || historyStr === '[]') {
            alert('当前没有聊天记录可导出。');
            return;
        }

        try {
            // 2. 格式化 JSON 为了可读性 (可选，如果文件太大可以去掉 null, 2)
            var formattedJson = JSON.stringify(JSON.parse(historyStr), null, 2);
            
            // 3. 创建 Blob 对象
            var blob = new Blob([formattedJson], {type: "application/json"});
            var url = URL.createObjectURL(blob);
            
            // 4. 创建临时下载链接并点击
            var a = document.createElement('a');
            a.href = url;
            // 生成文件名: waifu_history_2023-10-27.json
            var dateStr = new Date().toISOString().split('T')[0];
            a.download = 'waifu_chat_history_' + dateStr + '.json';
            document.body.appendChild(a);
            a.click();
            
            // 5. 清理
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } catch (e) {
            console.error(e);
            alert('导出失败，数据格式可能损坏。');
        }
    });

    // --- 导入聊天记录 (点击按钮触发文件选择) ---
    $('#btn-import-history').click(function() {
        $('#file-import-input').click();
    });

    // --- 导入逻辑 (文件选择后) ---
    $('#file-import-input').change(function(e) {
        var file = e.target.files[0];
        if (!file) return;

        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                var jsonStr = e.target.result;
                // 1. 尝试解析以验证是否为合法 JSON
                var json = JSON.parse(jsonStr);
                
                // 2. 简单验证格式 (必须是数组)
                if (!Array.isArray(json)) {
                    throw new Error("文件格式错误：聊天记录必须是数组列表");
                }

                // 3. 确认覆盖
                if (confirm('导入将覆盖当前所有的聊天记忆，确定要继续吗？')) {
                    localStorage.setItem('waifu_chat_history', JSON.stringify(json));
                    alert('导入成功！');
                }
            } catch (err) {
                console.error(err);
                alert('导入失败：文件内容不是有效的 JSON 格式。\n' + err.message);
            }
            // 清空 input 使得同一个文件可以再次被选中
            $('#file-import-input').val('');
        };
        // 读取文件
        reader.readAsText(file);
    });

    // ==========================================
    // [settings-content.html] 模型调试 UI (消费者)
    // ==========================================
    if (document.getElementById('debug-motion-select')) {
        var lastExportTime = 0;

        function refreshDebugUI() {
            var infoStr = localStorage.getItem('waifu_debug_info');
            if (!infoStr) return;

            var info = JSON.parse(infoStr);
            if (info.timestamp <= lastExportTime) return;
            
            console.log("[Debug] 正在刷新动作列表...");
            lastExportTime = info.timestamp;

            // 1. 填充表情 (保持不变)
            var $expr = $('#debug-expression-select');
            var oldExpr = $expr.val();
            $expr.empty().append('<option value="">选择表情...</option>');
            if(Array.isArray(info.expressions)){
                info.expressions.forEach(name => $expr.append(`<option value="${name}">${name}</option>`));
            }
            $expr.val(oldExpr);

            // 2. 填充动作 (核心修改：支持二级结构)
            var $motion = $('#debug-motion-select');
            var oldMotion = $motion.val();
            $motion.empty().append('<option value="">选择具体的动作文件...</option>');
            
            // info.motions 现在是 { "idle": ["file1", "file2"], "tap": [...] }
            if (info.motions && typeof info.motions === 'object') {
                Object.keys(info.motions).forEach(function(groupName) {
                    var fileList = info.motions[groupName];
                    
                    // 创建分组标签
                    var $group = $(`<optgroup label="${groupName}"></optgroup>`);
                    
                    // 遍历该组下的所有文件
                    fileList.forEach(function(filename, index) {
                        // value 格式： "groupName:index" (例如 "idle:0")
                        // 显示文本： "[0] Breath1.mtn"
                        var cleanName = filename.split('/').pop(); // 去掉路径，只留文件名
                        $group.append(`<option value="${groupName}:${index}" data-filename="${cleanName}">[${index}] ${cleanName}</option>`);
                    });
                    
                    $motion.append($group);
                });
            }
            $motion.val(oldMotion);
        }

        // 轮询
        setInterval(refreshDebugUI, 2000);
        refreshDebugUI();

        // --- 事件绑定 ---

        $('#debug-expression-select').off('change').on('change', function() {
            var name = $(this).val();
            if (!name) return;
            var cmd = { type: 'expression', name: name, id: Date.now() };
            sendCommand(cmd);
        });

        // 播放动作 (修改：解析 value 中的 group:index)
        $('#btn-play-motion').off('click').on('click', function() {
            var rawVal = $('#debug-motion-select').val(); // "idle:0"
            if (!rawVal) return;

            var parts = rawVal.split(':');
            var groupName = parts[0];
            var index = parseInt(parts[1]);
            var filename = $('#debug-motion-select option:selected').text();

            var cmd = { 
                type: 'motion', 
                name: groupName, 
                index: index, 
                filename: filename,
                id: Date.now() 
            };
            sendCommand(cmd);
        });

        // 统一发送函数
        function sendCommand(cmd) {
            if (typeof window.executeDebugCommand === 'function' && typeof window.Live2DManager !== 'undefined') {
                window.executeDebugCommand(cmd);
            } else {
                localStorage.setItem('waifu_debug_command', JSON.stringify(cmd));
            }
        }
    }
</script>