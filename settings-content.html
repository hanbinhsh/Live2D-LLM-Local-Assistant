<!-- 顶部 Tab 导航 -->
<div class="settings-tabs">
    <div class="settings-tab-item active" data-tab="general">常规</div>
    <div class="settings-tab-item" data-tab="style">样式</div>
    <div class="settings-tab-item" data-tab="toolbar">工具栏</div>
    <div class="settings-tab-item" data-tab="llm">LLM</div>
    <div class="settings-tab-item" data-tab="report">记录</div>
    <div class="settings-tab-item" data-tab="debug">调试</div>
</div>
<div class="settings-content">
    <!-- Tab 1: 常规设置 (接口、提示消息、杂项) -->
    <div id="tab-general" class="tab-pane active">
        <div class="setting-section-title">后端与API</div>
        <div class="setting-group">
            <label class="setting-label">一言 API 源</label>
            <select data-key="hitokotoAPI" class="waifu-select config-item">
                <option value="hitokoto.cn">hitokoto.cn (默认)</option>
                <option value="lwl12.com">lwl12.com</option>
                <option value="jinrishici.com">jinrishici.com (古诗词)</option>
                <option value="fghrsh.net">fghrsh.net</option>
            </select>
        </div>
        <div class="setting-group">
            <label class="setting-label">Tips JSON 路径</label>
            <input data-key="tipsMessage" class="waifu-select config-item" type="text">
        </div>
        <div class="setting-section-title">交互与提示消息</div>
        <div class="setting-group checkbox-group">
            <label><input data-key="showHitokoto" class="config-item" type="checkbox"> 显示一言 (空闲时)</label>
            <label><input data-key="showWelcomeMessage" class="config-item" type="checkbox"> 显示欢迎词</label>
            <label><input data-key="showCopyMessage" class="config-item" type="checkbox"> 显示复制提示</label>
            <label><input data-key="showF12Status" class="config-item" type="checkbox"> F12 显示加载状态</label>
            <label><input data-key="showF12Message" class="config-item" type="checkbox"> F12 显示看板娘消息</label>
            <label><input data-key="showF12OpenMsg" class="config-item" type="checkbox"> F12 显示打开提示</label>
        </div>
        <div class="setting-section-title">模型切换偏好</div>
        <div class="setting-group checkbox-group">
            <label><input data-key="modelStorage" class="config-item" type="checkbox"> 记录模型ID (刷新恢复)</label>
        </div>
        <div class="setting-group">
            <label class="setting-label">模型切换模式</label>
            <select data-key="modelRandMode" class="waifu-select config-item">
                <option value="switch">顺序切换</option>
                <option value="rand">随机切换</option>
            </select>
        </div>
        <div class="setting-group">
            <label class="setting-label">材质切换模式</label>
            <select data-key="modelTexturesRandMode" class="waifu-select config-item">
                <option value="rand">随机切换</option>
                <option value="switch">顺序切换</option>
            </select>
        </div>
    </div>
    <!-- Tab 2: 样式设置 -->
    <div id="tab-style" class="tab-pane" style="display:none;">
        <div class="setting-section-title">尺寸与位置 (需刷新生效)</div>
        <div class="setting-group">
            <label class="setting-label">看板娘大小 (宽x高)</label>
            <input data-key="waifuSize" class="waifu-select config-item" type="text" placeholder="280x250">
        </div>
        <div class="setting-group">
            <label class="setting-label">提示框大小 (宽x高)</label>
            <input data-key="waifuTipsSize" class="waifu-select config-item" type="text" placeholder="250x75">
        </div>
        <div class="setting-group">
            <label class="setting-label">字体大小</label>
            <input data-key="waifuFontSize" class="waifu-select config-item" type="text" placeholder="12px">
        </div>
        <div class="setting-group">
            <label class="setting-label">贴边设置 (left:0 / right:30)</label>
            <input data-key="waifuEdgeSide" class="waifu-select config-item" type="text">
        </div>
        <div class="setting-section-title">工具栏样式</div>
        <div class="setting-group">
            <label class="setting-label">工具栏字体大小</label>
            <input data-key="waifuToolFont" class="waifu-select config-item" type="text" placeholder="14px">
        </div>
        <div class="setting-group">
            <label class="setting-label">工具栏行高</label>
            <input data-key="waifuToolLine" class="waifu-select config-item" type="text" placeholder="20px">
        </div>
        <div class="setting-group">
            <label class="setting-label">工具栏顶部偏移</label>
            <input data-key="waifuToolTop" class="waifu-select config-item" type="text" placeholder="-20px">
        </div>
        
        <div class="setting-section-title">交互行为</div>
        <div class="setting-group">
            <label class="setting-label">拖拽设置</label>
            <select data-key="waifuDraggable" class="waifu-select config-item">
                <option value="disable">禁用拖拽</option>
                <option value="axis-x">水平拖拽</option>
                <option value="unlimited">自由拖拽</option>
            </select>
        </div>
        <div class="setting-group checkbox-group">
            <label><input data-key="waifuDraggableRevert" class="config-item" type="checkbox"> 松开鼠标还原位置</label>
        </div>
    </div>
    <!-- Tab 3: 工具栏设置 -->
    <div id="tab-toolbar" class="tab-pane" style="display:none;">
        <div class="setting-section-title">按钮显示开关</div>
        <div class="setting-group checkbox-group">
            <label><input data-key="showToolMenu" class="config-item" type="checkbox"> <b>显示整个工具栏</b></label>
            <hr>
            <label><input data-key="canTurnToHomePage" class="config-item" type="checkbox"> 返回首页 (房子)</label>
            <label><input data-key="canSwitchHitokoto" class="config-item" type="checkbox"> 一言切换 (气泡)</label>
            <label><input data-key="canSwitchModel" class="config-item" type="checkbox"> 模型切换 (眼睛)</label>
            <label><input data-key="canSwitchTextures" class="config-item" type="checkbox"> 材质切换 (衣服)</label>
            <label><input data-key="canTakeScreenshot" class="config-item" type="checkbox"> 看板娘截图 (相机)</label>
            <label><input data-key="canTurnToAboutPage" class="config-item" type="checkbox"> 关于页 (信息)</label>
            <label><input data-key="canCloseLive2d" class="config-item" type="checkbox"> 关闭看板娘 (叉号)</label>
            <label><input data-key="showLLM" class="config-item" type="checkbox"> LLM 对话 (星星)</label>
            <label><input data-key="showHistory" class="config-item" type="checkbox"> 对话历史 (信封)</label>
            <label><input data-key="showPeek" class="config-item" type="checkbox"> Peek 屏幕观察 (录像机)</label>
            <label><input data-key="showSettings" class="config-item" type="checkbox"> 设置面板 (齿轮)</label>
        </div>
    </div>
    <!-- Tab 4: LLM 设置 -->
    <div id="tab-llm" class="tab-pane" style="display:none;">
        <div class="setting-section-title">核心接口配置</div>
        <div class="setting-group">
            <label class="setting-label">LLM API 地址</label>
            <input data-key="llmApiUrl" class="waifu-select config-item" type="text" placeholder="http://127.0.0.1:11434/v1/chat/completions">
        </div>
        <div class="setting-group">
            <label class="setting-label">API Key (Ollama可留空)</label>
            <input data-key="llmApiKey" class="waifu-select config-item" type="password">
        </div>
        <div class="setting-group">
            <label class="setting-label">Python 后端地址 (Peek)</label>
            <input data-key="pythonServerUrl" class="waifu-select config-item" type="text" placeholder="http://127.0.0.1:11542/">
        </div>
        <div class="setting-section-title" style="margin-top:15px;">模型选择</div>
        <div class="setting-group">
            <label class="setting-label">
                普通模型 (响应快)
                <button id="btn-refresh-models" class="waifu-btn secondary" style="padding:1px 5px;font-size:10px;float:right;">刷新列表</button>
            </label>
            <select id="model-normal" data-key="modelNormal" class="waifu-select config-item">
                <option value="">点击刷新...</option>
            </select>
        </div>
        <div class="setting-group">
            <label class="setting-label">思考模型 (能力强)</label>
            <select id="model-thinking" data-key="modelThinking" class="waifu-select config-item">
                <option value="">点击刷新...</option>
            </select>
        </div>
        <div class="setting-section-title" style="margin-top:15px;">功能开关</div>
        <div class="setting-group checkbox-group">
            <label><input id="use-thinking-waifu" data-key="useThinkingWaifu" class="config-item" type="checkbox"> 看板娘对话使用思考模型</label>
            <label><input id="use-thinking-chat" data-key="useThinkingChat" class="config-item" type="checkbox"> 聊天助手使用思考模型</label>
            <label><input id="use-thinking-roast" data-key="useThinkingRoast" class="config-item" type="checkbox"> 屏幕吐槽使用思考模型</label>
        </div>
        <div class="setting-section-title">对话记忆</div>
        <div class="setting-group checkbox-group">
            <label><input id="use-memory" data-key="useMemory" class="llm-item config-item" type="checkbox"> 多轮对话记忆</label>
            <span style="font-size:12px;color:#999;">看板娘会记得你说过的话 (刷新网页依然有效)</span>
        </div>
        <div class="setting-group">
            <label class="setting-label">记忆轮数限制 (1轮=一问一答)</label>
            <div style="display:flex; gap:10px;">
                <input id="memory-limit" data-key="memoryLimit" class="waifu-select llm-item config-item" type="number" placeholder="10" style="width:80px; flex:none;">
                <button id="btn-clear-memory" class="waifu-btn secondary" style="float:right;padding:1px 5px;font-size:10px;">清除记忆</button>
                <button id="btn-export-history" class="waifu-btn secondary" style="float:right;padding:1px 5px;font-size:10px;">
                    导出记录
                </button>
                <button id="btn-import-history" class="waifu-btn secondary" style="float:right;padding:1px 5px;font-size:10px;">
                    导入记录
                </button>
                <input type="file" id="file-import-input" accept=".json" style="display:none;">
            </div>
        </div>
        <div class="setting-section-title" style="margin-top:15px;">自动与定时</div>
        <div class="setting-group checkbox-group">
            <label><input data-key="autoRoast" class="config-item" type="checkbox"> 开启自动定时吐槽</label>
        </div>
        <div class="setting-group">
            <label class="setting-label">自动间隔 (毫秒, 60000=1分钟)</label>
            <input data-key="roastInterval" class="waifu-select config-item" type="number">
        </div>
        <hr style="border:0; border-top:1px dashed #ddd; margin:15px 0;">
        <div class="setting-section-title">提示词</div>
        <div class="setting-group" id="group-prompt-waifu" style="margin-top:10px;">
            <label class="setting-label">
                看板娘人设 (对话模式)
                <button id="btn-reset-waifu" class="waifu-btn secondary" style="float:right;padding:1px 5px;font-size:10px;">重置</button>
            </label>
            <textarea id="prompt-waifu" data-key="waifuPrompt" class="waifu-textarea config-item"></textarea>
        </div>
        <hr style="border:0; border-top:1px dashed #ddd; margin:15px 0;">
        <div class="setting-section-title">Peek 详细参数</div>
        <div class="setting-group">
            <label class="setting-label">功能模式</label>
            <select id="peek-mode" data-key="peekMode" class="waifu-select config-item">
                <option value="roast">屏幕吐槽 (Roast)</option>
                <option value="chat">聊天助手 (Chat Helper)</option>
            </select>
        </div>
        <div class="setting-group">
            <label class="setting-label">截图范围</label>
            <select id="peek-target-type" data-key="targetType" class="waifu-select config-item">
                <option value="fullscreen">全屏截图</option>
                <option value="window">指定窗口</option>
            </select>
        </div>
        <div class="setting-group" id="group-window-select" style="display:none;">
            <label class="setting-label">
                选择窗口 
                <button id="btn-refresh-windows" class="waifu-btn secondary" style="padding:2px 5px; font-size:10px;">刷新</button>
            </label>
            <select id="peek-window-list" data-key="targetHwid" class="waifu-select config-item">
                <option value="0">请点击刷新...</option>
            </select>
        </div>
        <div class="setting-group prompt-group" id="group-prompt-roast" style="margin-top:10px;">
            <label class="setting-label">
                吐槽提示词 
                <span style="font-size:10px; color:#888; font-weight:normal;">
                    支持占位符: <code style="background:#eee;">/window_title</code> (当前活动窗口标题), 
                    <code style="background:#eee;">/window_list</code> (当前窗口列表)
                </span>
                <button id="btn-reset-roast" class="waifu-btn secondary" style="float:right;padding:1px 5px;font-size:10px;">重置</button>
            </label>
            <textarea id="prompt-roast" data-key="roastPrompt" class="waifu-textarea config-item"></textarea>
        </div>
        <div class="setting-group prompt-group" id="group-prompt-chat" style="display:none;margin-top:10px;">
            <label class="setting-label">
                助手提示词
                <span style="font-size:10px; color:#888; font-weight:normal;">
                    支持占位符: <code style="background:#eee;">/window_title</code> (当前活动窗口标题), 
                    <code style="background:#eee;">/window_list</code> (当前窗口列表)
                </span>
                <button id="btn-reset-chat" class="waifu-btn secondary" style="float:right;padding:1px 5px;font-size:10px;">重置</button>
            </label>
            <textarea id="prompt-chat" data-key="chatPrompt" class="waifu-textarea config-item"></textarea>
        </div>
    </div>
    <!-- Tab 5: 报告中心 -->
    <div id="tab-report" class="tab-pane" style="display:none;">
        <div class="setting-section-title">报告生成与配置</div>
        
        <!-- 1. 功能开关与配置 -->
        <div class="setting-group checkbox-group">
            <label><input id="report-enabled" type="checkbox" checked> 开启后台活动记录</label>
        </div>
        
        <div class="setting-group mtn-group">
            <label class="setting-label">
                自定义提示词 (Template)
                <span style="font-size:10px; color:#888; font-weight:normal;">
                    支持占位符: <code style="background:#eee;">/data:50</code> (插入50条活动数据), 
                    <code style="background:#eee;">/chat_context:20</code> (插入20条对话)
                </span>
            </label>
            <textarea id="report-prompt" class="waifu-textarea config-item"></textarea>
        </div>
        
        <!-- 2. 生成操作区 -->
        <div class="setting-group" style="display:flex; gap:5px; margin-top:10px;">
            <select id="report-type" class="waifu-select" style="flex:1;">
                <option value="daily">生成今日日报</option>
                <option value="weekly">生成本周周报</option>
                <option value="sql">执行自定义 SQL</option>
            </select>
            <button id="btn-gen-report" class="waifu-btn secondary">生成报告</button>
        </div>
        
        <!-- SQL 输入框 (仅当选择 SQL 时显示) -->
        <div id="sql-container" style="display:none; margin-top:5px;">
            <textarea id="report-sql" class="waifu-textarea" style="font-family:monospace; color:#2c3e50;" placeholder="SELECT app_name, SUM(duration) FROM activities GROUP BY app_name"></textarea>
        </div>
        
        <!-- 3. 历史报告列表 -->
        <div class="setting-section-title" style="margin-top:15px;">
            历史报告 
            <button id="btn-refresh-reports" class="waifu-btn secondary" style="float:right; font-size:10px;">刷新</button>
        </div>
        <ul id="report-file-list" style="list-style:none; padding:0; max-height:100px; overflow-y:auto; border:1px solid #eee;">
            <!-- JS 填充 -->
        </ul>

        <!-- 4. 原始数据管理 -->
        <hr style="border:0; border-top:1px dashed #ddd; margin:15px 0;">
        <div class="setting-section-title">
            原始数据管理
            <div style="float:right;">
                <button id="btn-refresh-data" class="waifu-btn secondary" style="font-size:10px;">刷新表</button>
                <button id="btn-clear-data" class="waifu-btn secondary" style="font-size:10px; color:red;">清空数据</button>
            </div>
        </div>
        
        <div class="setting-group">
            <input id="data-search" class="waifu-select" placeholder="搜索应用名或标题..." style="width:100%;">
        </div>
        
        <!-- 数据表格 -->
        <div style="overflow-x:auto; border:1px solid #eee; margin-top:5px;">
            <table id="activity-table" style="width:100%; font-size:12px; text-align:left; border-collapse:collapse;">
                <thead style="background:#f5f7fa; color:#606266;">
                    <tr>
                        <th style="padding:5px;">时间</th>
                        <th style="padding:5px;">应用</th>
                        <th style="padding:5px;">标题</th>
                        <th style="padding:5px;">时长(s)</th>
                    </tr>
                </thead>
                <tbody style="color:#333;"></tbody>
            </table>
        </div>
        <div style="text-align:center; margin-top:5px;">
            <button id="btn-prev-page" class="waifu-btn secondary">上一页</button>
            <span id="page-info" style="font-size:12px; margin:0 5px;">1 / 1</span>
            <button id="btn-next-page" class="waifu-btn secondary">下一页</button>
        </div>
    </div>
    <!-- Tab 6: 模型调试 -->
    <div id="tab-debug" class="tab-pane" style="display:none;">
        <div class="setting-section-title">模型调试 (Debug)</div>
        <div class="setting-group">
            <label class="setting-label">表情 (Expression)</label>
            <select id="debug-expression-select" class="waifu-select config-item">
                <option value="">加载中...</option>
            </select>
        </div>
        <div class="setting-group">
            <label class="setting-label">动作 (Motion)</label>
            <select id="debug-motion-select" class="waifu-select config-item">
                <option value="">加载中...</option>
            </select>
            <button id="btn-play-motion" class="waifu-btn secondary" style="margin-left:5px;">播放</button>
        </div>
        <hr style="border:0; border-top:1px dashed #ddd; margin:15px 0;">
        <div class="setting-section-title">高级动作调试</div>
        <div class="setting-group mtn-group">
            <label class="setting-label">
                输入 .mtn 文件内容
                <button id="btn-play-raw" class="waifu-btn secondary" style="float:right;padding:1px 5px;font-size:10px;">执行动作</button>
            </label>
            <textarea id="debug-raw-mtn" class="waifu-textarea config-item" placeholder="# Live2D Animator Motion Data..."></textarea>
        </div>
    </div>  
    <!-- 底部保存提示 -->
    <div style="text-align:center; padding:10px; color:#888; font-size:12px; border-top:1px solid #eee; background:#fafafa;">
        部分设置刷新网页后生效
    </div>
</div>

<script>

    // --- Tab 切换 ---
    $('.settings-tab-item').click(function() {
        $('.settings-tab-item').removeClass('active');
        $(this).addClass('active');
        $('.tab-pane').hide();
        $('#tab-' + $(this).data('tab')).show();
    });

    $('#btn-export-history').click(function() {
        // 1. 获取数据
        var historyStr = localStorage.getItem('waifu_chat_history');
        if (!historyStr || historyStr === '[]') {
            alert('当前没有聊天记录可导出。');
            return;
        }

        var jsonData = JSON.parse(historyStr);
        fetch(live2d_settings.pythonServerUrl + 'history/export', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ data: jsonData })
        })
        .then(r => r.json())
        .then(res => {
            if(res.success) {
                alert("导出成功！文件已保存至:\n" + res.path);
            } else {
                // 如果后端失败（比如只是普通浏览器访问），回退到 Blob 下载
                console.warn("后端导出失败，尝试浏览器下载", res.error);
                fallbackExport(historyStr);
            }
        })
        .catch(e => {
            alert('导出失败，网络错误。');
            fallbackExport(historyStr);
        });
    });

    function fallbackExport(content) {
        try {
            alert('点击了按钮');
            // 2. 格式化 JSON 为了可读性 (可选，如果文件太大可以去掉 null, 2)
            var formattedJson = JSON.stringify(JSON.parse(historyStr), null, 2);
            
            // 3. 创建 Blob 对象
            var blob = new Blob([formattedJson], {type: "application/json"});
            var url = URL.createObjectURL(blob);
            
            // 4. 创建临时下载链接并点击
            var a = document.createElement('a');
            a.href = url;
            // 生成文件名: waifu_history_2023-10-27.json
            var dateStr = new Date().toISOString().split('T')[0];
            a.download = 'waifu_chat_history_' + dateStr + '.json';
            document.body.appendChild(a);
            a.click();
            
            // 5. 清理
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } catch (e) {
            console.error(e);
            alert('导出失败，数据格式可能损坏。');
        }
    }

    // --- 导入聊天记录 (点击按钮触发文件选择) ---
    $('#btn-import-history').click(function() {
        $('#file-import-input').click();
    });

    // --- 导入逻辑 (文件选择后) ---
    $('#file-import-input').change(function(e) {
        var file = e.target.files[0];
        if (!file) return;

        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                var jsonStr = e.target.result;
                // 1. 尝试解析以验证是否为合法 JSON
                var json = JSON.parse(jsonStr);
                
                // 2. 简单验证格式 (必须是数组)
                if (!Array.isArray(json)) {
                    throw new Error("文件格式错误：聊天记录必须是数组列表");
                }

                // 3. 确认覆盖
                if (confirm('导入将覆盖当前所有的聊天记忆，确定要继续吗？')) {
                    localStorage.setItem('waifu_chat_history', JSON.stringify(json));
                    alert('导入成功！');
                }
            } catch (err) {
                console.error(err);
                alert('导入失败：文件内容不是有效的 JSON 格式。\n' + err.message);
            }
            // 清空 input 使得同一个文件可以再次被选中
            $('#file-import-input').val('');
        };
        // 读取文件
        reader.readAsText(file);
    });

    // ==========================================
    // [settings-content.html] 模型调试 UI (消费者)
    // ==========================================
    if (document.getElementById('debug-motion-select')) {
        var lastExportTime = 0;

        function refreshDebugUI() {
            var infoStr = localStorage.getItem('waifu_debug_info');
            if (!infoStr) return;

            var info = JSON.parse(infoStr);
            if (info.timestamp <= lastExportTime) return;
            
            console.log("[Debug] 正在刷新动作列表...");
            lastExportTime = info.timestamp;

            // 1. 填充表情 (保持不变)
            var $expr = $('#debug-expression-select');
            var oldExpr = $expr.val();
            $expr.empty().append('<option value="">选择表情...</option>');
            if(Array.isArray(info.expressions)){
                info.expressions.forEach(name => $expr.append(`<option value="${name}">${name}</option>`));
            }
            $expr.val(oldExpr);

            // 2. 填充动作 (核心修改：支持二级结构)
            var $motion = $('#debug-motion-select');
            var oldMotion = $motion.val();
            $motion.empty().append('<option value="">选择具体的动作文件...</option>');
            
            // info.motions 现在是 { "idle": ["file1", "file2"], "tap": [...] }
            if (info.motions && typeof info.motions === 'object') {
                Object.keys(info.motions).forEach(function(groupName) {
                    var fileList = info.motions[groupName];
                    
                    // 创建分组标签
                    var $group = $(`<optgroup label="${groupName}"></optgroup>`);
                    
                    // 遍历该组下的所有文件
                    fileList.forEach(function(filename, index) {
                        // value 格式： "groupName:index" (例如 "idle:0")
                        // 显示文本： "[0] Breath1.mtn"
                        var cleanName = filename.split('/').pop(); // 去掉路径，只留文件名
                        $group.append(`<option value="${groupName}:${index}" data-filename="${cleanName}">[${index}] ${cleanName}</option>`);
                    });
                    
                    $motion.append($group);
                });
            }
            $motion.val(oldMotion);
        }

        // 轮询
        setInterval(refreshDebugUI, 2000);
        refreshDebugUI();

        // --- 事件绑定 ---

        $('#debug-expression-select').off('change').on('change', function() {
            var name = $(this).val();
            if (!name) return;
            var cmd = { type: 'expression', name: name, id: Date.now() };
            sendCommand(cmd);
        });

        // 播放动作 (修改：解析 value 中的 group:index)
        $('#btn-play-motion').off('click').on('click', function() {
            var rawVal = $('#debug-motion-select').val(); // "idle:0"
            if (!rawVal) return;

            var parts = rawVal.split(':');
            var groupName = parts[0];
            var index = parseInt(parts[1]);
            var filename = $('#debug-motion-select option:selected').text();

            var cmd = { 
                type: 'motion', 
                name: groupName, 
                index: index, 
                filename: filename,
                id: Date.now() 
            };
            sendCommand(cmd);
        });

        // 统一发送函数
        function sendCommand(cmd) {
            if (typeof window.executeDebugCommand === 'function' && typeof window.Live2DManager !== 'undefined') {
                window.executeDebugCommand(cmd);
            } else {
                localStorage.setItem('waifu_debug_command', JSON.stringify(cmd));
            }
        }
    }

    $('#btn-play-raw').off('click').on('click', function() {
        var rawData = $('#debug-raw-mtn').val();
        if (!rawData || rawData.trim() === "") {
            alert("请先输入 motion 数据");
            return;
        }

        var cmd = { 
            type: 'raw_motion', 
            data: rawData, 
            id: Date.now() 
        };

        // 发送指令 (兼容同窗口和跨窗口)
        if (typeof window.executeDebugCommand === 'function' && typeof window.Live2DManager !== 'undefined') {
            window.executeDebugCommand(cmd);
        } else {
            localStorage.setItem('waifu_debug_command', JSON.stringify(cmd));
        }
    });

    // ==========================================
    // 报告中心
    // ==========================================
    if (document.getElementById('report-type')) {
        let currentPage = 1;
        
        // 切换 SQL 显示
        $('#report-type').change(function() {
            if($(this).val() === 'sql') $('#sql-container').show();
            else $('#sql-container').hide();
        });

        // 刷新数据表
        function loadActivityData(page) {
            let search = $('#data-search').val();
            fetch(live2d_settings.pythonServerUrl + `report/data?page=${page}&size=10&search=${search}`)
            .then(r=>r.json())
            .then(res => {
                let tbody = $('#activity-table tbody');
                tbody.empty();
                res.rows.forEach(row => {
                    // row: [id, date, time, app, title, duration]
                    tbody.append(`
                        <tr style="border-bottom:1px solid #eee;">
                            <td style="padding:4px;">${row[1]} ${row[2]}</td>
                            <td style="padding:4px;">${row[3]}</td>
                            <td style="padding:4px;">${row[4].substring(0, 20)}...</td>
                            <td style="padding:4px;">${row[5]}</td>
                        </tr>
                    `);
                });
                $('#page-info').text(res.page + " / " + Math.ceil(res.total/10));
                currentPage = res.page;
            });
        }

        $('#btn-refresh-data').click(() => loadActivityData(1));
        $('#btn-prev-page').click(() => { if(currentPage > 1) loadActivityData(currentPage-1); });
        $('#btn-next-page').click(() => loadActivityData(currentPage+1));
        $('#data-search').change(() => loadActivityData(1));

        // 生成报告
        $('#btn-gen-report').click(function() {
            let model = $('#model-normal').val();
            if(!model) { alert("请先在 LLM设置 中选择模型"); return; }
            
            showMessage("正在分析数据并编写报告，可能需要几十秒...", 6000, true);
            
            // 1. 获取聊天历史
            let historyStr = localStorage.getItem('waifu_chat_history') || "[]";
            let history = [];
            try {
                history = JSON.parse(historyStr);
            } catch(e) {}

            // 为了防止请求体过大，限制最近 100 条，或者根据你的需求调整
            // 后端会根据 /chat_context:N 再进行二次裁剪
            let historyToSend = history //.slice(-100); 

            let payload = {
                model: model,
                type: $('#report-type').val(),
                sql: $('#report-sql').val(),
                chat_history: historyToSend,
                prompt_template: $('#report-prompt').val()
            };

            fetch(live2d_settings.pythonServerUrl + 'report/generate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
            .then(r=>r.json())
            .then(res => {
                if(res.success) {
                    showMessage("报告生成成功！", 3000, true);
                    loadReportList(); // 刷新文件列表
                    // 自动打开预览
                    window.open(live2d_settings.pythonServerUrl + "storage/user_report/html/" + res.filename);
                } else {
                    alert("生成失败: " + res.reply);
                }
            });
        });

        // 刷新报告列表
        function loadReportList() {
            fetch(live2d_settings.pythonServerUrl + 'report/list')
            .then(r=>r.json())
            .then(res => {
                let ul = $('#report-file-list');
                ul.empty();
                res.files.forEach(f => {
                    let url = live2d_settings.pythonServerUrl + "storage/user_report/html/" + f;
                    ul.append(`
                        <li style="padding:5px; border-bottom:1px dashed #eee; display:flex; justify-content:space-between;">
                            <a href="#" onclick="window.open('${url}')">${f}</a>
                            <span style="font-size:10px; color:#999; cursor:pointer;" onclick="window.open('${url}')">查看</span>
                        </li>
                    `);
                });
            });
        }
        $('#btn-refresh-reports').click(loadReportList);
        
        // 初始加载
        // loadActivityData(1); // 考虑到性能，可以不自动加载，让用户点刷新
        loadReportList();
    }
    // ==========================================
    // 报告中心结束
    // ==========================================
</script>