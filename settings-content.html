<!-- é¡¶éƒ¨ Tab å¯¼èˆª -->
<div class="settings-tabs">
    <div class="settings-tab-item active" data-tab="general">å¸¸è§„</div>
    <div class="settings-tab-item" data-tab="style">æ ·å¼</div>
    <div class="settings-tab-item" data-tab="toolbar">å·¥å…·æ </div>
    <div class="settings-tab-item" data-tab="llm">LLM</div>
    <div class="settings-tab-item" data-tab="report">è®°å½•</div>
    <div class="settings-tab-item" data-tab="debug">è°ƒè¯•</div>
</div>
<div class="settings-content">
    <!-- Tab 1: å¸¸è§„è®¾ç½® (æ¥å£ã€æç¤ºæ¶ˆæ¯ã€æ‚é¡¹) -->
    <div id="tab-general" class="tab-pane active">
        <div class="setting-section-title">åç«¯ä¸API</div>
        <div class="setting-group">
            <label class="setting-label">ä¸€è¨€ API æº</label>
            <select data-key="hitokotoAPI" class="waifu-select config-item">
                <option value="hitokoto.cn">hitokoto.cn (é»˜è®¤)</option>
                <option value="lwl12.com">lwl12.com</option>
                <option value="jinrishici.com">jinrishici.com (å¤è¯—è¯)</option>
                <option value="fghrsh.net">fghrsh.net</option>
            </select>
        </div>
        <div class="setting-group">
            <label class="setting-label">Tips JSON è·¯å¾„</label>
            <input data-key="tipsMessage" class="waifu-select config-item" type="text">
        </div>
        <div class="setting-section-title">äº¤äº’ä¸æç¤ºæ¶ˆæ¯</div>
        <div class="setting-group checkbox-group">
            <label><input data-key="showHitokoto" class="config-item" type="checkbox"> æ˜¾ç¤ºä¸€è¨€ (ç©ºé—²æ—¶)</label>
            <label><input data-key="showWelcomeMessage" class="config-item" type="checkbox"> æ˜¾ç¤ºæ¬¢è¿è¯</label>
            <label><input data-key="showCopyMessage" class="config-item" type="checkbox"> æ˜¾ç¤ºå¤åˆ¶æç¤º</label>
            <label><input data-key="showF12Status" class="config-item" type="checkbox"> F12 æ˜¾ç¤ºåŠ è½½çŠ¶æ€</label>
            <label><input data-key="showF12Message" class="config-item" type="checkbox"> F12 æ˜¾ç¤ºçœ‹æ¿å¨˜æ¶ˆæ¯</label>
            <label><input data-key="showF12OpenMsg" class="config-item" type="checkbox"> F12 æ˜¾ç¤ºæ‰“å¼€æç¤º</label>
        </div>
        <div class="setting-section-title">æ¨¡å‹åˆ‡æ¢åå¥½</div>
        <div class="setting-group checkbox-group">
            <label><input data-key="modelStorage" class="config-item" type="checkbox"> è®°å½•æ¨¡å‹ID (åˆ·æ–°æ¢å¤)</label>
        </div>
        <div class="setting-group">
            <label class="setting-label">æ¨¡å‹åˆ‡æ¢æ¨¡å¼</label>
            <select data-key="modelRandMode" class="waifu-select config-item">
                <option value="switch">é¡ºåºåˆ‡æ¢</option>
                <option value="rand">éšæœºåˆ‡æ¢</option>
            </select>
        </div>
        <div class="setting-group">
            <label class="setting-label">æè´¨åˆ‡æ¢æ¨¡å¼</label>
            <select data-key="modelTexturesRandMode" class="waifu-select config-item">
                <option value="rand">éšæœºåˆ‡æ¢</option>
                <option value="switch">é¡ºåºåˆ‡æ¢</option>
            </select>
        </div>
    </div>
    <!-- Tab 2: æ ·å¼è®¾ç½® -->
    <div id="tab-style" class="tab-pane" style="display:none;">
        <div class="setting-section-title">å°ºå¯¸ä¸ä½ç½® (éœ€åˆ·æ–°ç”Ÿæ•ˆ)</div>
        <div class="setting-group">
            <label class="setting-label">çœ‹æ¿å¨˜å¤§å° (å®½xé«˜)</label>
            <input data-key="waifuSize" class="waifu-select config-item" type="text" placeholder="280x250">
        </div>
        <div class="setting-group">
            <label class="setting-label">æç¤ºæ¡†å¤§å° (å®½xé«˜)</label>
            <input data-key="waifuTipsSize" class="waifu-select config-item" type="text" placeholder="250x75">
        </div>
        <div class="setting-group">
            <label class="setting-label">å­—ä½“å¤§å°</label>
            <input data-key="waifuFontSize" class="waifu-select config-item" type="text" placeholder="12px">
        </div>
        <div class="setting-group">
            <label class="setting-label">è´´è¾¹è®¾ç½® (left:0 / right:30)</label>
            <input data-key="waifuEdgeSide" class="waifu-select config-item" type="text">
        </div>
        <div class="setting-section-title">å·¥å…·æ æ ·å¼</div>
        <div class="setting-group">
            <label class="setting-label">å·¥å…·æ å­—ä½“å¤§å°</label>
            <input data-key="waifuToolFont" class="waifu-select config-item" type="text" placeholder="14px">
        </div>
        <div class="setting-group">
            <label class="setting-label">å·¥å…·æ è¡Œé«˜</label>
            <input data-key="waifuToolLine" class="waifu-select config-item" type="text" placeholder="20px">
        </div>
        <div class="setting-group">
            <label class="setting-label">å·¥å…·æ é¡¶éƒ¨åç§»</label>
            <input data-key="waifuToolTop" class="waifu-select config-item" type="text" placeholder="-20px">
        </div>
        
        <div class="setting-section-title">äº¤äº’è¡Œä¸º</div>
        <div class="setting-group">
            <label class="setting-label">æ‹–æ‹½è®¾ç½®</label>
            <select data-key="waifuDraggable" class="waifu-select config-item">
                <option value="disable">ç¦ç”¨æ‹–æ‹½</option>
                <option value="axis-x">æ°´å¹³æ‹–æ‹½</option>
                <option value="unlimited">è‡ªç”±æ‹–æ‹½</option>
            </select>
        </div>
        <div class="setting-group checkbox-group">
            <label><input data-key="waifuDraggableRevert" class="config-item" type="checkbox"> æ¾å¼€é¼ æ ‡è¿˜åŸä½ç½®</label>
        </div>
    </div>
    <!-- Tab 3: å·¥å…·æ è®¾ç½® -->
    <div id="tab-toolbar" class="tab-pane" style="display:none;">
        <div class="setting-section-title">æŒ‰é’®æ˜¾ç¤ºå¼€å…³</div>
        <div class="setting-group checkbox-group">
            <label><input data-key="showToolMenu" class="config-item" type="checkbox"> <b>æ˜¾ç¤ºæ•´ä¸ªå·¥å…·æ </b></label>
            <hr>
            <label><input data-key="canTurnToHomePage" class="config-item" type="checkbox"> è¿”å›é¦–é¡µ (æˆ¿å­)</label>
            <label><input data-key="canSwitchHitokoto" class="config-item" type="checkbox"> ä¸€è¨€åˆ‡æ¢ (æ°”æ³¡)</label>
            <label><input data-key="canSwitchModel" class="config-item" type="checkbox"> æ¨¡å‹åˆ‡æ¢ (çœ¼ç›)</label>
            <label><input data-key="canSwitchTextures" class="config-item" type="checkbox"> æè´¨åˆ‡æ¢ (è¡£æœ)</label>
            <label><input data-key="canTakeScreenshot" class="config-item" type="checkbox"> çœ‹æ¿å¨˜æˆªå›¾ (ç›¸æœº)</label>
            <label><input data-key="canTurnToAboutPage" class="config-item" type="checkbox"> å…³äºé¡µ (ä¿¡æ¯)</label>
            <label><input data-key="canCloseLive2d" class="config-item" type="checkbox"> å…³é—­çœ‹æ¿å¨˜ (å‰å·)</label>
            <label><input data-key="showLLM" class="config-item" type="checkbox"> LLM å¯¹è¯ (æ˜Ÿæ˜Ÿ)</label>
            <label><input data-key="showHistory" class="config-item" type="checkbox"> å¯¹è¯å†å² (ä¿¡å°)</label>
            <label><input data-key="showPeek" class="config-item" type="checkbox"> Peek å±å¹•è§‚å¯Ÿ (å½•åƒæœº)</label>
            <label><input data-key="showReport" class="config-item" type="checkbox"> æ—¥å¿—ç”Ÿæˆ (æ—¥å†)</label>
            <label><input data-key="showSettings" class="config-item" type="checkbox"> è®¾ç½®é¢æ¿ (é½¿è½®)</label>
        </div>
    </div>
    <!-- Tab 4: LLM è®¾ç½® -->
    <div id="tab-llm" class="tab-pane" style="display:none;">
        <div class="setting-section-title">æ ¸å¿ƒæ¥å£é…ç½®</div>
        <div class="setting-group">
            <label class="setting-label">LLM API åœ°å€</label>
            <input data-key="llmApiUrl" class="waifu-select config-item" type="text" placeholder="http://127.0.0.1:11434/v1/chat/completions">
        </div>
        <div class="setting-group">
            <label class="setting-label">API Key (Ollamaå¯ç•™ç©º)</label>
            <input data-key="llmApiKey" class="waifu-select config-item" type="password">
        </div>
        <div class="setting-group">
            <label class="setting-label">Python åç«¯åœ°å€ (Peek)</label>
            <input data-key="pythonServerUrl" class="waifu-select config-item" type="text" placeholder="http://127.0.0.1:11542/">
        </div>
        <div class="setting-section-title" style="margin-top:15px;">
            æ¨¡å‹é€‰æ‹©
            <div style="float:right;"><button id="" class="waifu-btn secondary btn-refresh-models">åˆ·æ–°åˆ—è¡¨</button></div>
        </div>
        <div class="setting-group">
            <label class="setting-label">
                æ™®é€šæ¨¡å‹ (å“åº”å¿«)
            </label>
            <select id="model-normal" data-key="modelNormal" class="waifu-select config-item">
                <option value="">ç‚¹å‡»åˆ·æ–°...</option>
            </select>
        </div>
        <div class="setting-group">
            <label class="setting-label">æ€è€ƒæ¨¡å‹ (èƒ½åŠ›å¼º)</label>
            <select id="model-thinking" data-key="modelThinking" class="waifu-select config-item">
                <option value="">ç‚¹å‡»åˆ·æ–°...</option>
            </select>
        </div>
        <div class="setting-section-title" style="margin-top:15px;">åŠŸèƒ½å¼€å…³</div>
        <div class="setting-group checkbox-group">
            <label><input id="use-thinking-waifu" data-key="useThinkingWaifu" class="config-item" type="checkbox"> çœ‹æ¿å¨˜å¯¹è¯ä½¿ç”¨æ€è€ƒæ¨¡å‹</label>
            <label><input id="use-thinking-chat" data-key="useThinkingChat" class="config-item" type="checkbox"> èŠå¤©åŠ©æ‰‹ä½¿ç”¨æ€è€ƒæ¨¡å‹</label>
            <label><input id="use-thinking-roast" data-key="useThinkingRoast" class="config-item" type="checkbox"> å±å¹•åæ§½ä½¿ç”¨æ€è€ƒæ¨¡å‹</label>
        </div>
        <div class="setting-section-title">å¯¹è¯è®°å¿†</div>
        <div class="setting-group checkbox-group">
            <label><input id="use-memory" data-key="useMemory" class="llm-item config-item" type="checkbox"> å¤šè½®å¯¹è¯è®°å¿†</label>
            <span style="font-size:12px;color:#999;">çœ‹æ¿å¨˜ä¼šè®°å¾—ä½ è¯´è¿‡çš„è¯ (åˆ·æ–°ç½‘é¡µä¾ç„¶æœ‰æ•ˆ)</span>
        </div>
        <div class="setting-group">
            <label class="setting-label">è®°å¿†è½®æ•°é™åˆ¶ (1è½®=ä¸€é—®ä¸€ç­”)</label>
            <div style="display:flex; gap:10px;">
                <input id="memory-limit" data-key="memoryLimit" class="waifu-select llm-item config-item" type="number" placeholder="10" style="width:80px; flex:none;">
                <button id="btn-clear-memory" class="waifu-btn secondary" style="float:right;padding:1px 5px;font-size:10px;">æ¸…é™¤è®°å¿†</button>
                <button id="btn-export-history" class="waifu-btn secondary" style="float:right;padding:1px 5px;font-size:10px;">
                    å¯¼å‡ºè®°å½•
                </button>
                <button id="btn-import-history" class="waifu-btn secondary" style="float:right;padding:1px 5px;font-size:10px;">
                    å¯¼å…¥è®°å½•
                </button>
                <input type="file" id="file-import-input" accept=".json" style="display:none;">
            </div>
        </div>
        <div class="setting-section-title" style="margin-top:15px;">è‡ªåŠ¨ä¸å®šæ—¶</div>
        <div class="setting-group checkbox-group">
            <label><input data-key="autoRoast" class="config-item" type="checkbox"> å¼€å¯è‡ªåŠ¨å®šæ—¶åæ§½</label>
        </div>
        <div class="setting-group">
            <label class="setting-label">è‡ªåŠ¨é—´éš” (æ¯«ç§’, 60000=1åˆ†é’Ÿ)</label>
            <input data-key="roastInterval" class="waifu-select config-item" type="number">
        </div>
        <hr style="border:0; border-top:1px dashed #ddd; margin:15px 0;">
        <div class="setting-section-title">
            æç¤ºè¯
            <div style="float:right;"><button id="btn-reset-waifu" class="waifu-btn secondary">é‡ç½®</button></div>
        </div>
        <div class="setting-group mtn-group" id="group-prompt-waifu" style="margin-top:10px;">
            <label class="setting-label">
                çœ‹æ¿å¨˜äººè®¾ (å¯¹è¯æ¨¡å¼)
            </label>
            <textarea id="prompt-waifu" data-key="waifuPrompt" class="waifu-textarea config-item"></textarea>
        </div>
        <hr style="border:0; border-top:1px dashed #ddd; margin:15px 0;">
        <div class="setting-section-title">Peek è¯¦ç»†å‚æ•°</div>
        <div class="setting-group">
            <label class="setting-label">åŠŸèƒ½æ¨¡å¼</label>
            <select id="peek-mode" data-key="peekMode" class="waifu-select config-item">
                <option value="roast">å±å¹•åæ§½ (Roast)</option>
                <option value="chat">èŠå¤©åŠ©æ‰‹ (Chat Helper)</option>
            </select>
        </div>
        <div class="setting-group">
            <label class="setting-label">æˆªå›¾èŒƒå›´</label>
            <select id="peek-target-type" data-key="targetType" class="waifu-select config-item">
                <option value="fullscreen">å…¨å±æˆªå›¾</option>
                <option value="window">æŒ‡å®šçª—å£</option>
            </select>
        </div>
        <div class="setting-group" id="group-window-select" style="display:none;">
            <label class="setting-label">
                é€‰æ‹©çª—å£ 
                <button id="btn-refresh-windows" class="waifu-btn secondary" style="padding:2px 5px; font-size:10px;">åˆ·æ–°</button>
            </label>
            <select id="peek-window-list" data-key="targetHwid" class="waifu-select config-item">
                <option value="0">è¯·ç‚¹å‡»åˆ·æ–°...</option>
            </select>
        </div>
        <div class="setting-group prompt-group" id="group-prompt-roast" style="margin-top:10px;">
            <label class="setting-label">
                åæ§½æç¤ºè¯ 
                <span style="font-size:10px; color:#888; font-weight:normal;">
                    æ”¯æŒå ä½ç¬¦: <code style="background:#eee;">/window_title</code> (å½“å‰æ´»åŠ¨çª—å£æ ‡é¢˜), 
                    <code style="background:#eee;">/window_list</code> (å½“å‰çª—å£åˆ—è¡¨)
                </span>
                <button id="btn-reset-roast" class="waifu-btn secondary" style="float:right">é‡ç½®</button>
            </label>
            <textarea id="prompt-roast" data-key="roastPrompt" class="waifu-textarea config-item"></textarea>
        </div>
        <div class="setting-group prompt-group" id="group-prompt-chat" style="display:none;margin-top:10px;">
            <label class="setting-label">
                åŠ©æ‰‹æç¤ºè¯
                <span style="font-size:10px; color:#888; font-weight:normal;">
                    æ”¯æŒå ä½ç¬¦: <code style="background:#eee;">/window_title</code> (å½“å‰æ´»åŠ¨çª—å£æ ‡é¢˜), 
                    <code style="background:#eee;">/window_list</code> (å½“å‰çª—å£åˆ—è¡¨)
                </span>
                <button id="btn-reset-chat" class="waifu-btn secondary" style="float:right">é‡ç½®</button>
            </label>
            <textarea id="prompt-chat" data-key="chatPrompt" class="waifu-textarea config-item"></textarea>
        </div>
    </div>
    <!-- Tab 5: æŠ¥å‘Šä¸­å¿ƒ -->
    <div id="tab-report" class="tab-pane" style="display:none;">
        <div class="setting-section-title">æŠ¥å‘Šç”Ÿæˆä¸é…ç½®
            <div style="float:right;"><button id="btn-gen-report" class="waifu-btn secondary">ç”ŸæˆæŠ¥å‘Š</button></div>
        </div>
        
        <!-- 1. åŠŸèƒ½å¼€å…³ä¸é…ç½® -->
        <div class="setting-group">
            <label class="setting-label" style="color:#666;">
                åå°æ´»åŠ¨è®°å½•å¼€å…³
            </label>
            <div style="font-size:12px; color:#999; padding:5px 0;">
                è¯·åœ¨æ‰˜ç›˜èœå•çš„ "çª—å£åŠæ€§èƒ½é…ç½®" é¢æ¿ä¸­è¿›è¡Œè®¾ç½®ã€‚
            </div>
        </div>

        <div class="setting-group" style="display:flex; gap:5px; margin-top:10px;">
            <select id="report-type" class="waifu-select config-item" data-key="lastReportType" style="flex:1;">
                <option value="daily">ç”Ÿæˆä»Šæ—¥æ—¥æŠ¥</option>
                <option value="weekly">ç”Ÿæˆæœ¬å‘¨å‘¨æŠ¥</option>
                <option value="steam">ç”Ÿæˆ Steam æ¸¸æˆæŠ¥å‘Š</option>
                <option value="sql">æ‰§è¡Œè‡ªå®šä¹‰ SQL</option>
            </select>
        </div>

        <div class="setting-section-title" style="margin-top:10px; font-size:12px; color:#409eff;">Steam ç»Ÿè®¡é›†æˆ</div>
        <div class="setting-group" style="display:flex; gap:5px;">
            <div style="flex:1;">
                <label class="setting-label" style="font-size:11px;">Steam ID (64ä½æ•°å­—)</label>
                <input id="steam-id" class="waifu-select config-item" data-key="steamId" type="text" placeholder="ä¾‹å¦‚: 76561198xxxxxxxxx">
            </div>
            <div style="flex:1;">
                <label class="setting-label" style="font-size:11px;">
                    API Key 
                    <a href="https://steamcommunity.com/dev/apikey" target="_blank" style="color:#409eff;text-decoration:none;">(ç‚¹å‡»è·å–)</a>
                </label>
                <input id="steam-key" class="waifu-select config-item" data-key="steamApiKey" type="password" placeholder="åœ¨æ­¤ç²˜è´´ Key">
            </div>
        </div>

        <div class="setting-group">
            <label class="setting-label">
                æŠ¥å‘Šç”Ÿæˆæ¨¡å‹
                <button id="" class="waifu-btn secondary btn-refresh-models">åˆ·æ–°åˆ—è¡¨</button>
            </label>
            <select id="model-report" data-key="modelReport" class="waifu-select config-item">
                <option value="">ç‚¹å‡»åˆ·æ–°...</option>
            </select>
        </div>
        
        <!-- 2. æç¤ºè¯è®¾ç½® -->
        <div class="setting-group mtn-group">
            <label class="setting-label">
                è‡ªå®šä¹‰æç¤ºè¯
                <select id="prompt-type-select" class="waifu-select" style="width:120px; height:24px; padding:0 5px; font-size:11px;">
                    <option value="general">æ—¥æŠ¥/å‘¨æŠ¥æ¨¡æ¿</option>
                    <option value="steam">Steam æŠ¥å‘Šæ¨¡æ¿</option>
                </select>
                <button id="btn-reset-current-prompt" class="waifu-btn secondary">é‡ç½®</button>
            </label>
            <span style="font-size:10px; color:#888; font-weight:normal;">
                æ”¯æŒå ä½ç¬¦: <code style="background:#eee;">/data:50</code> (æ’å…¥50æ¡æ´»åŠ¨æ•°æ®), 
                <code style="background:#eee;">/chat_context:20</code> (æ’å…¥20æ¡å¯¹è¯),
                <code style="background:#eee;">/steam_profile</code> (steamä¸ªäººèµ„æ–™),
                <code style="background:#eee;">/steam_recent_games</code> (steamè¿‘æœŸæ¸¸æˆæ•°æ®),
                <code style="background:#eee;">/steam_games:50</code> (æ’å…¥50æ¡steamåº“å­˜),
            </span>
            <textarea id="report-prompt" class="waifu-textarea config-item"></textarea>
        </div>
        
        <!-- SQL è¾“å…¥æ¡† (ä»…å½“é€‰æ‹© SQL æ—¶æ˜¾ç¤º) -->
        <div id="sql-container" style="display:none; margin-top:5px;">
            <textarea id="report-sql" class="waifu-textarea" style="font-family:monospace; color:#2c3e50;" placeholder="SELECT app_name, SUM(duration) FROM activities GROUP BY app_name"></textarea>
        </div>
        
        <!-- 4. å†å²æŠ¥å‘Šåˆ—è¡¨ -->
        <div class="setting-section-title" style="margin-top:15px;">
            å†å²æŠ¥å‘Š 
            <div style="float:right;"><button id="btn-refresh-reports" class="waifu-btn secondary">åˆ·æ–°</button></div>
        </div>
        <ul id="report-file-list" style="list-style:none; padding:0; max-height:100px; overflow-y:auto; border:1px solid #eee;">
            <!-- JS å¡«å…… -->
        </ul>

        <!-- 5. åŸå§‹æ•°æ®ç®¡ç† -->
        <hr style="border:0; border-top:1px dashed #ddd; margin:15px 0;">
        <div class="setting-section-title">
            åŸå§‹æ•°æ®ç®¡ç†
            <div style="float:right;">
                <button id="btn-refresh-data" class="waifu-btn secondary">åˆ·æ–°è¡¨</button>
                <button id="btn-clear-data" class="waifu-btn secondary">æ¸…ç©ºæ•°æ®</button>
            </div>
        </div>
        
        <div class="setting-group">
            <input id="data-search" class="waifu-select" placeholder="æœç´¢åº”ç”¨åæˆ–æ ‡é¢˜..." style="width:100%;">
        </div>
        
        <!-- æ•°æ®è¡¨æ ¼ -->
        <div style="overflow-x:auto; border:1px solid #eee; margin-top:5px;">
            <table id="activity-table" style="width:100%; font-size:12px; text-align:left; border-collapse:collapse;">
                <thead style="background:#f5f7fa; color:#606266;">
                    <tr>
                        <th style="padding:5px;">æ—¶é—´</th>
                        <th style="padding:5px;">åº”ç”¨</th>
                        <th style="padding:5px;">æ ‡é¢˜</th>
                        <th style="padding:5px;">æ—¶é•¿(s)</th>
                    </tr>
                </thead>
                <tbody style="color:#333;"></tbody>
            </table>
        </div>
        <div style="text-align:center; margin-top:5px;">
            <button id="btn-prev-page" class="waifu-btn secondary" style="padding:2px 8px;">&lt;</button>
            <span id="page-info" style="font-size:12px; margin:0 10px; color:#666;">1 / 1</span>
            <button id="btn-next-page" class="waifu-btn secondary" style="padding:2px 8px;">&gt;</button>
        </div>
    </div>
    <!-- Tab 6: æ¨¡å‹è°ƒè¯• -->
    <div id="tab-debug" class="tab-pane" style="display:none;">
        <div class="setting-section-title">æ¨¡å‹è°ƒè¯• (Debug)</div>
        <div class="setting-group">
            <label class="setting-label">è¡¨æƒ… (Expression)</label>
            <select id="debug-expression-select" class="waifu-select config-item">
                <option value="">åŠ è½½ä¸­...</option>
            </select>
        </div>
        <div class="setting-group">
            <label class="setting-label">åŠ¨ä½œ (Motion)</label>
            <select id="debug-motion-select" class="waifu-select config-item">
                <option value="">åŠ è½½ä¸­...</option>
            </select>
            <button id="btn-play-motion" class="waifu-btn secondary" style="margin-left:5px;">æ’­æ”¾</button>
        </div>
        <hr style="border:0; border-top:1px dashed #ddd; margin:15px 0;">
        <div class="setting-section-title">é«˜çº§åŠ¨ä½œè°ƒè¯•</div>
        <div class="setting-group mtn-group">
            <label class="setting-label">
                è¾“å…¥ .mtn æ–‡ä»¶å†…å®¹
                <button id="btn-play-raw" class="waifu-btn secondary" style="float:right;padding:1px 5px;font-size:10px;">æ‰§è¡ŒåŠ¨ä½œ</button>
            </label>
            <textarea id="debug-raw-mtn" class="waifu-textarea config-item" placeholder="# Live2D Animator Motion Data..."></textarea>
        </div>
    </div>  
    <!-- åº•éƒ¨ä¿å­˜æç¤º -->
    <div style="text-align:center; padding:10px; color:#888; font-size:12px; border-top:1px solid #eee; background:#fafafa;">
        éƒ¨åˆ†è®¾ç½®åˆ·æ–°ç½‘é¡µåç”Ÿæ•ˆ
    </div>
</div>

<script>
    // --- Tab åˆ‡æ¢ ---
    $('.settings-tab-item').click(function() {
        $('.settings-tab-item').removeClass('active');
        $(this).addClass('active');
        $('.tab-pane').hide();
        $('#tab-' + $(this).data('tab')).show();
    });

    // ==========================================
    // [settings-content.html] èŠå¤©è®°å½•å¯¼å…¥å¯¼å‡ºåŠŸèƒ½
    // ==========================================
    $('#btn-export-history').click(function() {
        // 1. è·å–æ•°æ®
        var historyStr = localStorage.getItem('waifu_chat_history');
        if (!historyStr || historyStr === '[]') {
            alert('å½“å‰æ²¡æœ‰èŠå¤©è®°å½•å¯å¯¼å‡ºã€‚');
            return;
        }

        var jsonData = JSON.parse(historyStr);
        fetch(live2d_settings.pythonServerUrl + 'history/export', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ data: jsonData })
        })
        .then(r => r.json())
        .then(res => {
            if(res.success) {
                alert("å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶å·²ä¿å­˜è‡³:\n" + res.path);
            } else {
                // å¦‚æœåç«¯å¤±è´¥ï¼ˆæ¯”å¦‚åªæ˜¯æ™®é€šæµè§ˆå™¨è®¿é—®ï¼‰ï¼Œå›é€€åˆ° Blob ä¸‹è½½
                console.warn("åç«¯å¯¼å‡ºå¤±è´¥ï¼Œå°è¯•æµè§ˆå™¨ä¸‹è½½", res.error);
                fallbackExport(historyStr);
            }
        })
        .catch(e => {
            alert('å¯¼å‡ºå¤±è´¥ï¼Œç½‘ç»œé”™è¯¯ã€‚');
            fallbackExport(historyStr);
        });
    });

    function fallbackExport(content) {
        try {
            alert('ç‚¹å‡»äº†æŒ‰é’®');
            // 2. æ ¼å¼åŒ– JSON ä¸ºäº†å¯è¯»æ€§ (å¯é€‰ï¼Œå¦‚æœæ–‡ä»¶å¤ªå¤§å¯ä»¥å»æ‰ null, 2)
            var formattedJson = JSON.stringify(JSON.parse(historyStr), null, 2);
            
            // 3. åˆ›å»º Blob å¯¹è±¡
            var blob = new Blob([formattedJson], {type: "application/json"});
            var url = URL.createObjectURL(blob);
            
            // 4. åˆ›å»ºä¸´æ—¶ä¸‹è½½é“¾æ¥å¹¶ç‚¹å‡»
            var a = document.createElement('a');
            a.href = url;
            // ç”Ÿæˆæ–‡ä»¶å: waifu_history_2023-10-27.json
            var dateStr = new Date().toISOString().split('T')[0];
            a.download = 'waifu_chat_history_' + dateStr + '.json';
            document.body.appendChild(a);
            a.click();
            
            // 5. æ¸…ç†
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } catch (e) {
            console.error(e);
            alert('å¯¼å‡ºå¤±è´¥ï¼Œæ•°æ®æ ¼å¼å¯èƒ½æŸåã€‚');
        }
    }

    // --- å¯¼å…¥èŠå¤©è®°å½• (ç‚¹å‡»æŒ‰é’®è§¦å‘æ–‡ä»¶é€‰æ‹©) ---
    $('#btn-import-history').click(function() {
        $('#file-import-input').click();
    });

    // --- å¯¼å…¥é€»è¾‘ (æ–‡ä»¶é€‰æ‹©å) ---
    $('#file-import-input').change(function(e) {
        var file = e.target.files[0];
        if (!file) return;

        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                var jsonStr = e.target.result;
                // 1. å°è¯•è§£æä»¥éªŒè¯æ˜¯å¦ä¸ºåˆæ³• JSON
                var json = JSON.parse(jsonStr);
                
                // 2. ç®€å•éªŒè¯æ ¼å¼ (å¿…é¡»æ˜¯æ•°ç»„)
                if (!Array.isArray(json)) {
                    throw new Error("æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼šèŠå¤©è®°å½•å¿…é¡»æ˜¯æ•°ç»„åˆ—è¡¨");
                }

                // 3. ç¡®è®¤è¦†ç›–
                if (confirm('å¯¼å…¥å°†è¦†ç›–å½“å‰æ‰€æœ‰çš„èŠå¤©è®°å¿†ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                    localStorage.setItem('waifu_chat_history', JSON.stringify(json));
                    alert('å¯¼å…¥æˆåŠŸï¼');
                }
            } catch (err) {
                console.error(err);
                alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶å†…å®¹ä¸æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼ã€‚\n' + err.message);
            }
            // æ¸…ç©º input ä½¿å¾—åŒä¸€ä¸ªæ–‡ä»¶å¯ä»¥å†æ¬¡è¢«é€‰ä¸­
            $('#file-import-input').val('');
        };
        // è¯»å–æ–‡ä»¶
        reader.readAsText(file);
    });

    // ==========================================
    // [settings-content.html] æ¨¡å‹è°ƒè¯• UI (æ¶ˆè´¹è€…)
    // ==========================================
    if (document.getElementById('debug-motion-select')) {
        var lastExportTime = 0;

        function refreshDebugUI() {
            var infoStr = localStorage.getItem('waifu_debug_info');
            if (!infoStr) return;

            var info = JSON.parse(infoStr);
            if (info.timestamp <= lastExportTime) return;
            
            console.log("[Debug] æ­£åœ¨åˆ·æ–°åŠ¨ä½œåˆ—è¡¨...");
            lastExportTime = info.timestamp;

            // 1. å¡«å……è¡¨æƒ… (ä¿æŒä¸å˜)
            var $expr = $('#debug-expression-select');
            var oldExpr = $expr.val();
            $expr.empty().append('<option value="">é€‰æ‹©è¡¨æƒ…...</option>');
            if(Array.isArray(info.expressions)){
                info.expressions.forEach(name => $expr.append(`<option value="${name}">${name}</option>`));
            }
            $expr.val(oldExpr);

            // 2. å¡«å……åŠ¨ä½œ (æ ¸å¿ƒä¿®æ”¹ï¼šæ”¯æŒäºŒçº§ç»“æ„)
            var $motion = $('#debug-motion-select');
            var oldMotion = $motion.val();
            $motion.empty().append('<option value="">é€‰æ‹©å…·ä½“çš„åŠ¨ä½œæ–‡ä»¶...</option>');
            
            // info.motions ç°åœ¨æ˜¯ { "idle": ["file1", "file2"], "tap": [...] }
            if (info.motions && typeof info.motions === 'object') {
                Object.keys(info.motions).forEach(function(groupName) {
                    var fileList = info.motions[groupName];
                    
                    // åˆ›å»ºåˆ†ç»„æ ‡ç­¾
                    var $group = $(`<optgroup label="${groupName}"></optgroup>`);
                    
                    // éå†è¯¥ç»„ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
                    fileList.forEach(function(filename, index) {
                        // value æ ¼å¼ï¼š "groupName:index" (ä¾‹å¦‚ "idle:0")
                        // æ˜¾ç¤ºæ–‡æœ¬ï¼š "[0] Breath1.mtn"
                        var cleanName = filename.split('/').pop(); // å»æ‰è·¯å¾„ï¼Œåªç•™æ–‡ä»¶å
                        $group.append(`<option value="${groupName}:${index}" data-filename="${cleanName}">[${index}] ${cleanName}</option>`);
                    });
                    
                    $motion.append($group);
                });
            }
            $motion.val(oldMotion);
        }

        // è½®è¯¢
        setInterval(refreshDebugUI, 2000);
        refreshDebugUI();

        // --- äº‹ä»¶ç»‘å®š ---

        $('#debug-expression-select').off('change').on('change', function() {
            var name = $(this).val();
            if (!name) return;
            var cmd = { type: 'expression', name: name, id: Date.now() };
            sendCommand(cmd);
        });

        // æ’­æ”¾åŠ¨ä½œ (ä¿®æ”¹ï¼šè§£æ value ä¸­çš„ group:index)
        $('#btn-play-motion').off('click').on('click', function() {
            var rawVal = $('#debug-motion-select').val(); // "idle:0"
            if (!rawVal) return;

            var parts = rawVal.split(':');
            var groupName = parts[0];
            var index = parseInt(parts[1]);
            var filename = $('#debug-motion-select option:selected').text();

            var cmd = { 
                type: 'motion', 
                name: groupName, 
                index: index, 
                filename: filename,
                id: Date.now() 
            };
            sendCommand(cmd);
        });

        // ç»Ÿä¸€å‘é€å‡½æ•°
        function sendCommand(cmd) {
            if (typeof window.executeDebugCommand === 'function' && typeof window.Live2DManager !== 'undefined') {
                window.executeDebugCommand(cmd);
            } else {
                localStorage.setItem('waifu_debug_command', JSON.stringify(cmd));
            }
        }
    }

    $('#btn-play-raw').off('click').on('click', function() {
        var rawData = $('#debug-raw-mtn').val();
        if (!rawData || rawData.trim() === "") {
            alert("è¯·å…ˆè¾“å…¥ motion æ•°æ®");
            return;
        }

        var cmd = { 
            type: 'raw_motion', 
            data: rawData, 
            id: Date.now() 
        };

        // å‘é€æŒ‡ä»¤ (å…¼å®¹åŒçª—å£å’Œè·¨çª—å£)
        if (typeof window.executeDebugCommand === 'function' && typeof window.Live2DManager !== 'undefined') {
            window.executeDebugCommand(cmd);
        } else {
            localStorage.setItem('waifu_debug_command', JSON.stringify(cmd));
        }
    });

    // ==========================================
    // æŠ¥å‘Šä¸­å¿ƒ
    // ==========================================
    if (document.getElementById('report-type')) {
        let currentPage = 1;

        // 1. è·å–åç«¯åœ°å€
        function getServerUrl() {
            return $('input[data-key="pythonServerUrl"]').val() || 'http://127.0.0.1:11542/';
        }

        // 2. åˆå§‹åŒ–é…ç½®ä¸çŠ¶æ€æ¢å¤
        function initReportUI() {
            if (typeof live2d_settings === 'undefined') {
                console.log("ç­‰å¾… live2d_settings åŠ è½½...");
                setTimeout(initReportUI, 200); return;
            }
            updatePromptTextarea();
        }

        function updatePromptTextarea() {
            let type = $('#prompt-type-select').val(); // 'general' or 'steam'
            let content = "";
            
            if (type === 'steam') {
                content = live2d_settings.steamPrompt;
            } else {
                content = live2d_settings.reportPrompt; // general
            }
            
            // å¦‚æœä¸ºç©ºï¼ŒåŠ è½½é»˜è®¤å€¼
            if (!content && typeof window.WAIFU_GLOBAL_DEFAULTS !== 'undefined') {
                content = type === 'steam' ? window.WAIFU_GLOBAL_DEFAULTS.steamPrompt : window.WAIFU_GLOBAL_DEFAULTS.reportPrompt;
            }
            
            $('#report-prompt').val(content);
        }

        $('#prompt-type-select').change(function() {
            updatePromptTextarea();
        });

        $('#report-prompt').on('input propertychange', function() {
            let val = $(this).val();
            let type = $('#prompt-type-select').val();
            
            if (type === 'steam') {
                live2d_settings.steamPrompt = val;
            } else {
                live2d_settings.reportPrompt = val;
            }
            // ä¿å­˜åˆ° LocalStorage
            saveGlobalSettings();
        });

        $('#steam-id, #steam-key').change(function() {
            live2d_settings.steamId = $('#steam-id').val();
            live2d_settings.steamApiKey = $('#steam-key').val();
            saveGlobalSettings();
        });

        // 3. åˆ‡æ¢ SQL è¾“å…¥æ¡†
        $('#report-type').change(function() {
            let val = $(this).val();
            if(val === 'sql') $('#sql-container').show();
            else $('#sql-container').hide();
            
            // è‡ªåŠ¨åˆ‡æ¢æç¤ºè¯ä¸‹æ‹‰æ¡† (å¯é€‰ä¼˜åŒ–)
            if (val === 'steam') {
                $('#prompt-type-select').val('steam').trigger('change');
            } else if (val === 'daily' || val === 'weekly') {
                $('#prompt-type-select').val('general').trigger('change');
            }

            // ä¿å­˜é€‰æ‹©
            live2d_settings.lastReportType = val;
            saveGlobalSettings();
        });

        // 4. æ•°æ®è¡¨æ ¼åŠ è½½
        function loadActivityData(page) {
            let search = $('#data-search').val();
            let url = getServerUrl() + `report/data?page=${page}&size=10&search=${encodeURIComponent(search)}`;
            
            fetch(url)
            .then(r=>r.json())
            .then(res => {
                let tbody = $('#activity-table tbody');
                tbody.empty();
                if (res.rows && res.rows.length > 0) {
                    res.rows.forEach(row => {
                        tbody.append(`
                            <tr style="border-bottom:1px solid #eee;">
                                <td style="padding:4px;">${row[1]} ${row[2]}</td>
                                <td style="padding:4px;">${row[3]}</td>
                                <td style="padding:4px;" title="${row[4]}">${row[4].substring(0, 20)}...</td>
                                <td style="padding:4px;">${row[5]}</td>
                            </tr>
                        `);
                    });
                    $('#page-info').text(res.page + " / " + Math.ceil(res.total/10));
                    currentPage = res.page;
                } else {
                    tbody.html('<tr><td colspan="4" style="text-align:center;padding:10px;color:#999;">æš‚æ— æ•°æ®</td></tr>');
                }
            })
            .catch(e => console.log("æ•°æ®åŠ è½½å¤±è´¥"));
        }

        $('#btn-refresh-data').click(() => loadActivityData(1));
        $('#btn-prev-page').click(() => { if(currentPage > 1) loadActivityData(currentPage-1); });
        $('#btn-next-page').click(() => loadActivityData(currentPage+1));
        $('#data-search').change(() => loadActivityData(1));
        
        $('#btn-clear-data').click(() => {
            if(confirm("å±é™©æ“ä½œï¼šç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ")) {
                fetch(getServerUrl() + 'report/clear', {method:'POST'})
                .then(() => {
                    loadActivityData(1);
                });
            }
        });

        // 5. åˆ·æ–°æŠ¥å‘Šåˆ—è¡¨
        function loadReportList() {
            fetch(getServerUrl() + 'report/list')
            .then(r=>r.json())
            .then(res => {
                let ul = $('#report-file-list');
                ul.empty();
                if (res.files && res.files.length > 0) {
                    res.files.forEach(f => {
                        let url = getServerUrl() + "storage/user_report/html/" + f;
                        ul.append(`
                            <li style="padding:5px; border-bottom:1px dashed #eee; display:flex; justify-content:space-between;">
                                <a href="#" onclick="window.location.href='${url}';return false;" style="text-decoration:none; color:#333;">ğŸ“„ ${f}</a>
                                <span style="font-size:10px; color:#999; cursor:pointer;" onclick="window.location.href='${url}'">æŸ¥çœ‹</span>
                            </li>
                        `);
                    });
                } else {
                    ul.html('<li style="padding:10px; text-align:center; color:#999; font-size:12px;">æš‚æ— å†å²æŠ¥å‘Š</li>');
                }
            });
        }
        $('#btn-refresh-reports').click(loadReportList);

        // 6. ç”ŸæˆæŠ¥å‘Š
        $('#btn-gen-report').click(function() {
            // è·å–æ¨¡å‹ID (ä¼˜å…ˆä½¿ç”¨æŠ¥å‘Šä¸“ç”¨æ¨¡å‹)
            let model = $('#model-report').val(); 
            // å¦‚æœæ²¡é€‰æŠ¥å‘Šæ¨¡å‹ï¼Œå°è¯•ç”¨æ™®é€šæ¨¡å‹å…œåº•
            if (!model && typeof live2d_settings !== 'undefined') {
                 model = live2d_settings.modelNormal;
                 if (model && confirm("æœªé€‰æ‹©æŠ¥å‘Šä¸“ç”¨æ¨¡å‹ï¼Œæ˜¯å¦ä½¿ç”¨æ™®é€šå¯¹è¯æ¨¡å‹ç”Ÿæˆï¼Ÿ")) {
                     // pass
                 } else {
                     alert("è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡å‹ï¼"); return;
                 }
            }
            if (!model) { alert("è¯·å…ˆé€‰æ‹©æ¨¡å‹ï¼"); return; }
            
            // UI æç¤º
            var btn = $(this);
            var originText = btn.text();
            btn.text("ç”Ÿæˆä¸­...").prop("disabled", true);
            
            if (typeof showMessage === 'function') {
                live2d_settings.isLLMThinking = true;
                live2d_settings.isLLMWriting = true;
                showMessage("æ­£åœ¨ä½¿ç”¨ [" + model + "] åˆ†ææ•°æ®...", 6000, true);
                live2d_settings.isLLMThinking = false;
                live2d_settings.isLLMWriting = false;
            }
            
            let historyStr = localStorage.getItem('waifu_chat_history') || "[]";
            let history = [];
            try { history = JSON.parse(historyStr).slice(-100); } catch(e) {}

            let payload = {
                model: model,
                type: $('#report-type').val(),
                sql: $('#report-sql').val(),
                chat_history: history,
                steam_id: $('#steam-id').val(),
                steam_api_key: $('#steam-key').val(),
                prompt_template: $('#report-prompt').val()
            };

            fetch(getServerUrl() + 'report/generate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
            .then(r=>r.json())
            .then(res => {
                if(res.success) {
                    if (typeof showMessage === 'function') {
                        live2d_settings.isLLMThinking = true;
                        live2d_settings.isLLMWriting = true;
                        showMessage("æŠ¥å‘Šç”ŸæˆæˆåŠŸï¼", 3000, true);
                        live2d_settings.isLLMThinking = false;
                        live2d_settings.isLLMWriting = false;
                    }
                    loadReportList();
                    window.location.href = getServerUrl() + "storage/user_report/html/" + res.filename;
                } else {
                    alert("ç”Ÿæˆå¤±è´¥: " + res.reply);
                }
            })
            .catch(e => alert("è¯·æ±‚å¤±è´¥: " + e))
            .finally(() => {
                btn.text(originText).prop("disabled", false);
            });
        });

        setTimeout(initReportUI, 100);

        // 7. åˆ‡æ¢åˆ°æ­¤ Tab æ—¶è‡ªåŠ¨åŠ è½½æ•°æ® (æ‡’åŠ è½½)
        $('.settings-tab-item[data-tab="report"]').one('click', function() {
            loadReportList();
            loadActivityData(1);
        });
    }
    // ==========================================
    // æŠ¥å‘Šä¸­å¿ƒç»“æŸ
    // ==========================================

    // æç¤ºè¯é‡ç½®åŠŸèƒ½
    $('#btn-reset-current-prompt').click(function() {
        let type = $('#prompt-type-select').val();
        let typeName = type === 'steam' ? "Steam" : "æ—¥æŠ¥/å‘¨æŠ¥";
        
        if(confirm(`ç¡®å®šè¦é‡ç½®ã€${typeName}ã€‘æç¤ºè¯æ¨¡æ¿å—ï¼Ÿ`)) {
            let defaultVal = type === 'steam' ? default_settings.steamPrompt : default_settings.reportPrompt;
            if(type === 'steam') {
                live2d_settings.steamPrompt = default_settings.steamPrompt;
                $('#report-prompt').val(default_settings.steamPrompt);
            } else {
                live2d_settings.reportPrompt = default_settings.reportPrompt;
                $('#report-prompt').val(default_settings.reportPrompt);
            }
            saveGlobalSettings();
        }
    });
    $('#btn-reset-roast').click(function() {
        if(confirm('é‡ç½®åæ§½æç¤ºè¯ï¼Ÿ')) { 
            $('#prompt-roast').val(default_settings.roastPrompt); 
            live2d_settings.roastPrompt = default_settings.roastPrompt;
            saveGlobalSettings();
        }
    });
    $('#btn-reset-chat').click(function() {
        if(confirm('é‡ç½®åŠ©æ‰‹æç¤ºè¯ï¼Ÿ')) { 
            $('#prompt-chat').val(default_settings.chatPrompt); 
            live2d_settings.chatPrompt = default_settings.chatPrompt;
            saveGlobalSettings();
        }
    });
    $('#btn-reset-waifu').click(function(){ 
        if(confirm('é‡ç½®çœ‹æ¿å¨˜æç¤ºè¯ï¼Ÿ')) { 
            $('#prompt-waifu').val(defaultSettings.waifuPrompt); 
            live2d_settings.waifuPrompt = defaultSettings.waifuPrompt;
            saveGlobalSettings();
        }
    });

    // åˆ·æ–°æ¨¡å‹åˆ—è¡¨
    $('.btn-refresh-models').click(function() {
        window.WaifuShared.fetchModelList($(this));
    });

    // åˆ·æ–°çª—å£åˆ—è¡¨
    $('#btn-refresh-windows').click(async function() {window.WaifuShared.refreshWindowList($(this))});
</script>